<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Django 1.Django 介绍 1.1 组件 Django 包含的组件如下：
基本配置文件/路由系统 模型层(M)/模板层(T)/视图层(V) Cookies 和 Session 分页及分发邮件 Admin 管理后台 1.2 用途 Django 能够实现所有 HTTP 请求处理。
网站/微信公众号/小程序后端开发 人工智能平台融合 1.3 版本 Django 官网：The web framework for perfectionists with deadlines | Django (djangoproject.com) Django 中文文档参考网站：一译 (yiyibooks.cn) 版本： 教程版本：2.2.12 1.4 安装 1.4.1 在线安装 pip install django==2.2.12 1.4.2 离线安装 # 将安装包下载到本地 # 解压缩并进入到解压缩后的目录 # 执行如下命令进行安装 python setup.py install # 执行如下命令检查是否安装成功 pip freeze | grep -i &amp;#39;Django&amp;#39; 2.Django 的项目结构 2.1 创建项目 成功安装 Django 后，虚拟机终端会有 django-admin 命令'>
<title>达内教育Django全套教程</title>

<link rel='canonical' href='https://euansu123.github.io/post/django_tutorial/'>

<link rel="stylesheet" href="/scss/style.min.83fdf04f357d6c514ee15e600463b045549e8b40c428f14454adecaa742b352f.css"><meta property='og:title' content='达内教育Django全套教程'>
<meta property='og:description' content='Django 1.Django 介绍 1.1 组件 Django 包含的组件如下：
基本配置文件/路由系统 模型层(M)/模板层(T)/视图层(V) Cookies 和 Session 分页及分发邮件 Admin 管理后台 1.2 用途 Django 能够实现所有 HTTP 请求处理。
网站/微信公众号/小程序后端开发 人工智能平台融合 1.3 版本 Django 官网：The web framework for perfectionists with deadlines | Django (djangoproject.com) Django 中文文档参考网站：一译 (yiyibooks.cn) 版本： 教程版本：2.2.12 1.4 安装 1.4.1 在线安装 pip install django==2.2.12 1.4.2 离线安装 # 将安装包下载到本地 # 解压缩并进入到解压缩后的目录 # 执行如下命令进行安装 python setup.py install # 执行如下命令检查是否安装成功 pip freeze | grep -i &amp;#39;Django&amp;#39; 2.Django 的项目结构 2.1 创建项目 成功安装 Django 后，虚拟机终端会有 django-admin 命令'>
<meta property='og:url' content='https://euansu123.github.io/post/django_tutorial/'>
<meta property='og:site_name' content='EuanSu&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Python' /><meta property='article:tag' content='Django' /><meta property='article:published_time' content='2024-01-24T11:57:38&#43;08:00'/><meta property='article:modified_time' content='2024-01-24T11:57:38&#43;08:00'/><meta property='og:image' content='https://euansu123.github.io/img/%E8%BE%BE%E5%86%85%E6%95%99%E8%82%B2Django%E5%85%A8%E5%A5%97%E6%95%99%E7%A8%8B.jpg' />
<meta name="twitter:title" content="达内教育Django全套教程">
<meta name="twitter:description" content="Django 1.Django 介绍 1.1 组件 Django 包含的组件如下：
基本配置文件/路由系统 模型层(M)/模板层(T)/视图层(V) Cookies 和 Session 分页及分发邮件 Admin 管理后台 1.2 用途 Django 能够实现所有 HTTP 请求处理。
网站/微信公众号/小程序后端开发 人工智能平台融合 1.3 版本 Django 官网：The web framework for perfectionists with deadlines | Django (djangoproject.com) Django 中文文档参考网站：一译 (yiyibooks.cn) 版本： 教程版本：2.2.12 1.4 安装 1.4.1 在线安装 pip install django==2.2.12 1.4.2 离线安装 # 将安装包下载到本地 # 解压缩并进入到解压缩后的目录 # 执行如下命令进行安装 python setup.py install # 执行如下命令检查是否安装成功 pip freeze | grep -i &amp;#39;Django&amp;#39; 2.Django 的项目结构 2.1 创建项目 成功安装 Django 后，虚拟机终端会有 django-admin 命令"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://euansu123.github.io/img/%E8%BE%BE%E5%86%85%E6%95%99%E8%82%B2Django%E5%85%A8%E5%A5%97%E6%95%99%E7%A8%8B.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "light");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_huf4e58488b142d2a3fc54de6d76489e59_104192_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">EuanSu&#39;s Blog</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/post/django_tutorial/">
                
                    <img src="/img/%e8%be%be%e5%86%85%e6%95%99%e8%82%b2Django%e5%85%a8%e5%a5%97%e6%95%99%e7%a8%8b.jpg" loading="lazy" alt="Featured image of post 达内教育Django全套教程" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/django_tutorial/">达内教育Django全套教程</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 24, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    22 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="django">Django</h1>
<h2 id="1django-介绍">1.Django 介绍</h2>
<h3 id="11-组件">1.1 组件</h3>
<p><code>Django</code> 包含的组件如下：</p>
<ul>
<li>基本配置文件/路由系统</li>
<li>模型层(M)/模板层(T)/视图层(V)</li>
<li><code>Cookies</code> 和 <code>Session</code></li>
<li>分页及分发邮件</li>
<li><code>Admin</code> 管理后台</li>
</ul>
<h3 id="12-用途">1.2 用途</h3>
<p><code>Django</code> 能够实现所有 <code>HTTP</code> 请求处理。</p>
<ul>
<li>网站/微信公众号/小程序后端开发</li>
<li>人工智能平台融合</li>
</ul>
<h3 id="13-版本">1.3 版本</h3>
<ul>
<li><code>Django</code> 官网：<a class="link" href="http://www.djangoproject.com/"  target="_blank" rel="noopener"
    >The web framework for perfectionists with deadlines | Django (djangoproject.com)</a></li>
<li><code>Django</code> 中文文档参考网站：<a class="link" href="https://yiyibooks.cn/"  target="_blank" rel="noopener"
    >一译 (yiyibooks.cn)</a></li>
<li>版本：
<ul>
<li>教程版本：2.2.12</li>
</ul>
</li>
</ul>
<h3 id="14-安装">1.4 安装</h3>
<h4 id="141-在线安装">1.4.1 在线安装</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pip install django<span style="color:#f92672">==</span>2.2.12
</span></span></code></pre></div><h4 id="142-离线安装">1.4.2 离线安装</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 将安装包下载到本地</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解压缩并进入到解压缩后的目录</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行如下命令进行安装</span>
</span></span><span style="display:flex;"><span>python setup.py install
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行如下命令检查是否安装成功</span>
</span></span><span style="display:flex;"><span>pip freeze | grep -i <span style="color:#e6db74">&#39;Django&#39;</span>
</span></span></code></pre></div><h2 id="2django-的项目结构">2.Django 的项目结构</h2>
<h3 id="21-创建项目">2.1 创建项目</h3>
<ul>
<li>
<p>成功安装 <code>Django</code> 后，虚拟机终端会有 <code>django-admin</code> 命令</p>
</li>
<li>
<p>执行 <code>django-admin startproject [项目名]</code> 即可创建出对应项目的文件夹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建 mysite1 项目</span>
</span></span><span style="display:flex;"><span>django-admin startproject mysite1
</span></span></code></pre></div></li>
</ul>
<h3 id="22-启动服务">2.2 启动服务</h3>
<ul>
<li>启动[测试开发阶段]
<ol>
<li>
<p>终端 cd 进入到项目文件夹</p>
</li>
<li>
<p>进入到项目文件夹后，执行 <code>python manage.py runserver [端口]</code> 启动 <code>django</code> 服务，端口不指定即为 <code>8000</code>。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230807225358311.png"
	
	
	
	loading="lazy"
	
		alt="image-20230807225358311"
	
	
></p>
</li>
<li>
<p>浏览器访问 <code>http://127.0.0.1:8000</code> 可看到 <code>django</code> 的启动页面。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230807225440250.png"
	
	
	
	loading="lazy"
	
		alt="image-20230807225440250"
	
	
></p>
</li>
</ol>
</li>
</ul>
<h3 id="23-关闭服务">2.3 关闭服务</h3>
<ul>
<li>
<p>关闭服务[测试开发阶段]</p>
<ul>
<li>
<p>方式一[在runserver启动终端下]：</p>
<p>执行 <code>ctrl + c</code> 可退出 <code>Django</code> 服务。</p>
</li>
<li>
<p>方式二[在其他终端下]：</p>
<p>执行 <code>sudo lsof -i:8000</code> 查询出 <code>Django</code> 的进程 <code>id</code>。</p>
<p>执行 <code>kill -9 </code> <code>Django</code> 进程的 <code>id</code>。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230807225907267.png"
	
	
	
	loading="lazy"
	
		alt="image-20230807225907267"
	
	
></p>
</li>
</ul>
</li>
</ul>
<h3 id="24-项目结构解析">2.4 项目结构解析</h3>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230807230100663.png"
	
	
	
	loading="lazy"
	
		alt="image-20230807230100663"
	
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mysite
</span></span><span style="display:flex;"><span>├── db.sqlite3 <span style="color:#f92672">[</span>Django默认的数据库，sqlite<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>├── manage.py
</span></span><span style="display:flex;"><span>└── mysite
</span></span><span style="display:flex;"><span>    ├── __init__.py
</span></span><span style="display:flex;"><span>    ├── __pycache__
</span></span><span style="display:flex;"><span>    │   ├── __init__.cpython-310.pyc
</span></span><span style="display:flex;"><span>    │   ├── settings.cpython-310.pyc
</span></span><span style="display:flex;"><span>    │   ├── urls.cpython-310.pyc
</span></span><span style="display:flex;"><span>    │   └── wsgi.cpython-310.pyc
</span></span><span style="display:flex;"><span>    ├── settings.py
</span></span><span style="display:flex;"><span>    ├── urls.py
</span></span><span style="display:flex;"><span>    └── wsgi.py
</span></span></code></pre></div><p><strong>manage.py</strong></p>
<p>包含项目管理的子命令，如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 启动服务</span>
</span></span><span style="display:flex;"><span>python manage.py runserver
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建应用</span>
</span></span><span style="display:flex;"><span>python manage.py startapp <span style="color:#f92672">[</span>appname<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成迁移文件</span>
</span></span><span style="display:flex;"><span>python manage.py makemigrations
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 数据迁移</span>
</span></span><span style="display:flex;"><span>python manage.py migrate
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 直接执行 python manage.py 会列出所有Django的子命令</span>
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230807230440939.png"
	
	
	
	loading="lazy"
	
		alt="image-20230807230440939"
	
	
></p>
<p><strong>项目同名文件夹 - mysite/mysite</strong></p>
<ul>
<li><code>__init__</code> : <code>Python</code> 包的初始化文件。</li>
<li><code>wsgi.py</code> : <code>web</code> 服务网关配置文件，<code>Django</code> 正式启动时，需要用到。</li>
<li><code>urls.py</code> : 项目的主路由配置，<code>Http</code> 请求进入 <code>Django</code> 时，优先调用该文件。</li>
<li><code>settings.py</code> : 项目的配置文件，包含项目启动时需要的配置。</li>
</ul>
<p><strong>项目配置文件 - settings.py</strong></p>
<ul>
<li>
<p>settings.py 包含了 Django 项目启动时所有的配置项。</p>
</li>
<li>
<p>配置项分为公有配置和自定义配置。</p>
</li>
<li>
<p>配置项格式：BASE_DIR = &lsquo;xxxx&rsquo;。</p>
</li>
<li>
<p>公有配置，Django官方提供的基础配置，可到如下网站查询。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>https://docs.djangoproject.com/en/2.2/ref/settings/
</span></span></code></pre></div><p><strong>ALLOWED_HOSTS</strong></p>
<p>设置允许访问到本项目的 <code>host</code> 头值。</p>
<ul>
<li>
<p>示例：如果要在局域网其他主机也能访问此主机的Django服务，启动方式如下：</p>
<p>(1) python3 manage.py runserver 0.0.0.0:5000</p>
<p>(2) 指定网络设备如果内网环境下其他主机想正常访问该站点，需要添加 ALLOWED_HOSTS = [&lsquo;内网IP&rsquo;]</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230807232602075.png"
	
	
	
	loading="lazy"
	
		alt="image-20230807232602075"
	
	
></p>
<blockquote>
<p>在 windows 主机访问虚拟机启动的 Django 项目，显示主机ip应该添加到 ALLOWED_HOSTS，在 settings.py 添加后，再次访问，页面能够被正常文件。</p>
</blockquote>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230807232951884.png"
	
	
	
	loading="lazy"
	
		alt="image-20230807232951884"
	
	
></p>
</li>
</ul>
<p><strong>LANGUAGE_CODE</strong></p>
<p>设置项目的页面展示语言，简体中文设置为：<code>zh-Hans</code>。</p>
<p><strong>TIME_ZONE</strong></p>
<p>用于指定当前服务端时区，默认为格林威治时间(UTC)，中国地区设置为 <code>Asia/Shanghai</code>。</p>
<p><strong>BASE_DIR</strong></p>
<p>用于绑定当前项目的绝对路径（动态计算出来的），所有文件夹都可以依赖此路径。</p>
<p><strong>DEBUG</strong></p>
<p>用于配置 <code>Django</code> 项目的启动模式，取值：True，表示开发环境中使用；False，表示当前项目运行在生产环境中。</p>
<p><strong>INSTALLED_APPS</strong></p>
<p>指定当前项目中安装的应用列表。</p>
<p><strong>MIDDLEWARE</strong></p>
<p>用于注册中间件。</p>
<p><strong>TEMPLATES</strong></p>
<p>用于指定模板的配置信息。</p>
<p><strong>DATABASES</strong></p>
<p>用于指定数据库的配置信息。</p>
<p><strong>ROOT_URLCONF</strong></p>
<p>用于配置主 <code>url</code> 配置，<code>ROOT_URLCONF = 'mysite.urls'</code>。</p>
</li>
</ul>
<h2 id="3url-和-视图函数">3.URL 和 视图函数</h2>
<h3 id="31-url">3.1 URL</h3>
<p>定义：即统一资源定位符 Uniform Resource Locator</p>
<p>作用：用来表示互联网上某个资源的地址</p>
<p>URL的一般语法为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># portocol:协议(http、https、file)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># hostname:主机名</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># port:端口</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># path:路由地址</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># query:查询的参数，可有多个参数，用 &amp; 隔开，每个参数的名和值用 = 隔开。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># fragment:信息片段，字符串，用于指定网络资源中的片段。例如一个网页中有多个名词解释，可使用fragment直接定位到某一名词解释。</span>
</span></span><span style="display:flex;"><span>protocol://hostname<span style="color:#f92672">[</span>:port<span style="color:#f92672">]</span>/path<span style="color:#f92672">[</span>?query<span style="color:#f92672">][</span><span style="color:#75715e">#fragment]</span>
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 直接定位到页面指定信息片段的位置</span>
</span></span><span style="display:flex;"><span>https://docs.djangoproject.com/en/4.2/#how-the-documentation-is-organized
</span></span></code></pre></div><h3 id="32-处理-url-请求">3.2 处理 URL 请求</h3>
<p>以URL（http://127.0.0.1:8000/page/2003）为例。</p>
<ol>
<li><code>Django</code> 从配置文件中根据 <code>ROOT_URLCONF</code> 找到主路由文件；默认情况下，该文件为项目同名目录下的 <code>urls.py</code>。</li>
<li><code>Django</code> 加载主路由文件中的 <code>urlpatterns</code> 变量[包含很多路由的数组]。</li>
<li>依次匹配 <code>urlpatterns</code> 中的 <code>path</code> ，匹配到第一个合适的中断后续匹配。</li>
<li>匹配成功-调用对应的视图函数处理请求，返回响应。</li>
<li>匹配失败-返回 <code>404</code> 响应。</li>
</ol>
<p><strong>主路由 - urls.py</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib <span style="color:#f92672">import</span> admin
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> views
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;admin/&#39;</span>, admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>urls),
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;page/2023&#39;</span>, views<span style="color:#f92672">.</span>page_2023),
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;page/2024&#39;</span>, views<span style="color:#f92672">.</span>page_2024)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h3 id="33-视图函数">3.3 视图函数</h3>
<p>定义：视图函数是用于接收一个浏览器请求（HttpRequest对象）并通过HttpResponse对象返回响应的函数，此函数可以接收浏览器请求并根据业务逻辑返回响应的响应内容给浏览器。</p>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">xxx_view</span>(request[,其他参数]):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse 对象
</span></span></code></pre></div><p><strong>样例：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">page_2023</span>(request):
</span></span><span style="display:flex;"><span>    html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;这是第一个页面&lt;/h1&gt;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230809231829556.png"
	
	
	
	loading="lazy"
	
		alt="image-20230809231829556"
	
	
></p>
<h2 id="4路由配置">4.路由配置</h2>
<p><code>settings.py</code> 中的 <code>ROOT_URLCONF</code> 指定了主路由配置列表 <code>urlpatterns</code> 的文件位置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;admin/&#39;</span>, admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>urls),
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;page/2023/&#39;</span>, views<span style="color:#f92672">.</span>page_2023),
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;page/2024/&#39;</span>, views<span style="color:#f92672">.</span>page_2024),
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span> <span style="color:#75715e"># 配置URL和视图函数</span>
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h3 id="41-path-函数">4.1 path 函数</h3>
<p><strong>path函数定义</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 导入</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 语法</span>
</span></span><span style="display:flex;"><span>path(route,views,[name<span style="color:#f92672">=</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 参数</span>
</span></span><span style="display:flex;"><span>route:字符串类型<span style="color:#960050;background-color:#1e0010">，</span>匹配请求路径
</span></span><span style="display:flex;"><span>views:指定路径所对应视图函数的名称
</span></span><span style="display:flex;"><span>name:为路由地址起别名<span style="color:#960050;background-color:#1e0010">，</span>在模板中地址反向解析时使用
</span></span></code></pre></div><h3 id="42-path-转换器">4.2 path 转换器</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 语法</span>
</span></span><span style="display:flex;"><span>&lt;转换器类型:自定义名&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 作用</span>
</span></span><span style="display:flex;"><span>如果转换器类型匹配到对应类型的数据，则将数据按照关键字传参的方式传递给视图函数
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 例如</span>
</span></span><span style="display:flex;"><span>path<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;page/\&lt;int:page&gt;&#39;</span>,views.xxx<span style="color:#f92672">)</span>
</span></span></code></pre></div><p><strong>转换器列表</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>转换器类型</th>
<th>作用</th>
<th>样例</th>
</tr>
</thead>
<tbody>
<tr>
<td>str</td>
<td>匹配除了&rsquo;/&lsquo;之外的非空字符串</td>
<td><code>v1/users/&lt;str:username&gt;</code>匹配 <code>/v1/users/guoxiaonao</code></td>
</tr>
<tr>
<td>int</td>
<td>匹配0或者任意正整数，返回一个int</td>
<td><code>page/&lt;int:page&gt;</code> 匹配 <code>/page/100</code></td>
</tr>
<tr>
<td>slug</td>
<td>匹配任意由 ASCII字母或数字以及连字符和下划线组成的短标签</td>
<td><code>detail/&lt;slug:sl&gt;</code> 匹配 <code>/detail/this-is-django</code></td>
</tr>
<tr>
<td>path</td>
<td>匹配非空字段，包括路径分隔符&rsquo;/&rsquo;</td>
<td><code>v1/users/&lt;path:ph&gt;</code> 匹配 <code>/v1/goods/a/b/c</code></td>
</tr>
</tbody>
</table></div>
<p><strong>转换器测试</strong></p>
<p><code>int</code> 转换器测试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># URL</span>
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;page/&lt;int:number&gt;&#39;</span>, views<span style="color:#f92672">.</span>page_n)
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 视图函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">page_n</span>(request,number):
</span></span><span style="display:flex;"><span>    html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;这是第</span><span style="color:#e6db74">{number}</span><span style="color:#e6db74">个页面&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(number<span style="color:#f92672">=</span>number)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230809233613509.png"
	
	
	
	loading="lazy"
	
		alt="image-20230809233613509"
	
	
></p>
<p><code>str</code> 转换器测试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># URL</span>
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;page/&lt;str:name&gt;&#39;</span>, views<span style="color:#f92672">.</span>page_welcome),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 视图函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">page_welcome</span>(request, name):
</span></span><span style="display:flex;"><span>    html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;hello </span><span style="color:#e6db74">{name}</span><span style="color:#e6db74">!&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(name<span style="color:#f92672">=</span>name)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230809233831396.png"
	
	
	
	loading="lazy"
	
		alt="image-20230809233831396"
	
	
></p>
<p><code>slug</code> 转换器测试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># URL</span>
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;page/show/&lt;slug:slug&gt;&#39;</span>, views<span style="color:#f92672">.</span>page_show)
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 视图函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">page_show</span>(request, slug):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;title:</span><span style="color:#e6db74">{slug}</span><span style="color:#e6db74">&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(slug<span style="color:#f92672">=</span>slug)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 注意</span>
</span></span><span style="display:flex;"><span>使用slug时<span style="color:#960050;background-color:#1e0010">，</span>如果前方存在str的匹配<span style="color:#960050;background-color:#1e0010">，</span>会进入str的视图函数<span style="color:#960050;background-color:#1e0010">，</span>因为slug也是字符串
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230809234448118.png"
	
	
	
	loading="lazy"
	
		alt="image-20230809234448118"
	
	
></p>
<p><code>path</code> 转换器测试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># URL</span>
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;page/path/&lt;path:path&gt;&#39;</span>, views<span style="color:#f92672">.</span>path_mate)
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 视图函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">path_mate</span>(request, path):
</span></span><span style="display:flex;"><span>    html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;path:</span><span style="color:#e6db74">{path}</span><span style="color:#e6db74">&lt;/h2&gt;&#34;</span><span style="color:#f92672">.</span>format(path<span style="color:#f92672">=</span>path)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230809234825556.png"
	
	
	
	loading="lazy"
	
		alt="image-20230809234825556"
	
	
></p>
<p>转换器练习</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 定义一个路由器的格式为： http:127.0.0.1:8000/整数/操作字符串[add/sub/mul]/整数，从路由中提取数据，做相应的操作后返回给浏览器</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 代码如下：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## URL</span>
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;calculator/&lt;int:number1&gt;/&lt;str:method&gt;/&lt;int:number2&gt;&#39;</span>, views<span style="color:#f92672">.</span>calculator)
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 视图函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculator</span>(request, number1, method, number2):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> method <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;add&#39;</span>, <span style="color:#e6db74">&#39;sub&#39;</span>, <span style="color:#e6db74">&#39;mul&#39;</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;&lt;h1&gt;method </span><span style="color:#e6db74">{method}</span><span style="color:#e6db74"> is not support!&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(method<span style="color:#f92672">=</span>method))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;add&#39;</span>:
</span></span><span style="display:flex;"><span>        html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;</span><span style="color:#e6db74">{number1}</span><span style="color:#e6db74"> + </span><span style="color:#e6db74">{number2}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{result}</span><span style="color:#e6db74">&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(number1<span style="color:#f92672">=</span>number1, number2<span style="color:#f92672">=</span>number2, result<span style="color:#f92672">=</span>number1 <span style="color:#f92672">+</span> number2)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;sub&#39;</span>:
</span></span><span style="display:flex;"><span>        html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;</span><span style="color:#e6db74">{number1}</span><span style="color:#e6db74"> - </span><span style="color:#e6db74">{number2}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{result}</span><span style="color:#e6db74">&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(number1<span style="color:#f92672">=</span>number1, number2<span style="color:#f92672">=</span>number2, result<span style="color:#f92672">=</span>number1 <span style="color:#f92672">-</span> number2)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;</span><span style="color:#e6db74">{number1}</span><span style="color:#e6db74"> * </span><span style="color:#e6db74">{number2}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{result}</span><span style="color:#e6db74">&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(number1<span style="color:#f92672">=</span>number1, number2<span style="color:#f92672">=</span>number2, result<span style="color:#f92672">=</span>number1 <span style="color:#f92672">*</span> number2)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230809235732904.png"
	
	
	
	loading="lazy"
	
		alt="image-20230809235732904"
	
	
></p>
<h3 id="43-re_path-函数">4.3 re_path 函数</h3>
<p><strong>re_path 函数定义</strong></p>
<p>在 url 的匹配过程中可以使用正则表达式进行精确匹配。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 导入</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> re_path
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 语法</span>
</span></span><span style="display:flex;"><span>re_path(reg,view,[name<span style="color:#f92672">=</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 说明</span>
</span></span><span style="display:flex;"><span>正则表达式为命名分组模式(<span style="color:#960050;background-color:#1e0010">?</span>P<span style="color:#f92672">&lt;</span>name<span style="color:#f92672">&gt;</span>pattern)<span style="color:#960050;background-color:#1e0010">；</span>匹配提取参数后用关键字传参方式传递给视图函数
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 注意</span>
</span></span><span style="display:flex;"><span>使用正则表达式时<span style="color:#960050;background-color:#1e0010">，</span>需要尽量精准<span style="color:#960050;background-color:#1e0010">，</span>因此在正则表达式的末尾一定要添加 <span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#960050;background-color:#1e0010">，</span>否则会导致出现不想要的匹配效果
</span></span></code></pre></div><p><strong>re_path 函数示例</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 实现效果：使用 re_path 路由函数匹配数字和字符串，定义路由为 http:127.0.0.1:8000/整数/操作字符串[add/sub/mul]/整数，匹配整数均为两位数的操作</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># URL</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path,re_path
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    re_path(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;calculator/(?P&lt;number1&gt;\d{1,2})/(?P&lt;method&gt;\w+)/(?P&lt;number2&gt;\d{1,2})$&#39;</span>, views<span style="color:#f92672">.</span>calculator_reg),
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;calculator/&lt;int:number1&gt;/&lt;str:method&gt;/&lt;int:number2&gt;&#39;</span>, views<span style="color:#f92672">.</span>calculator),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 视图函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculator</span>(request, number1, method, number2):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> method <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;add&#39;</span>, <span style="color:#e6db74">&#39;sub&#39;</span>, <span style="color:#e6db74">&#39;mul&#39;</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;&lt;h1&gt;method </span><span style="color:#e6db74">{method}</span><span style="color:#e6db74"> is not support!&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(method<span style="color:#f92672">=</span>method))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;add&#39;</span>:
</span></span><span style="display:flex;"><span>        html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;</span><span style="color:#e6db74">{number1}</span><span style="color:#e6db74"> + </span><span style="color:#e6db74">{number2}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{result}</span><span style="color:#e6db74">&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(number1<span style="color:#f92672">=</span>number1, number2<span style="color:#f92672">=</span>number2, result<span style="color:#f92672">=</span>number1 <span style="color:#f92672">+</span> number2)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;sub&#39;</span>:
</span></span><span style="display:flex;"><span>        html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;</span><span style="color:#e6db74">{number1}</span><span style="color:#e6db74"> - </span><span style="color:#e6db74">{number2}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{result}</span><span style="color:#e6db74">&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(number1<span style="color:#f92672">=</span>number1, number2<span style="color:#f92672">=</span>number2, result<span style="color:#f92672">=</span>number1 <span style="color:#f92672">-</span> number2)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;</span><span style="color:#e6db74">{number1}</span><span style="color:#e6db74"> * </span><span style="color:#e6db74">{number2}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{result}</span><span style="color:#e6db74">&lt;/h1&gt;&#34;</span><span style="color:#f92672">.</span>format(number1<span style="color:#f92672">=</span>number1, number2<span style="color:#f92672">=</span>number2, result<span style="color:#f92672">=</span>number1 <span style="color:#f92672">*</span> number2)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculator_reg</span>(request, number1, method, number2):
</span></span><span style="display:flex;"><span>    html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;正则匹配&lt;/h1&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230810132355346.png"
	
	
	
	loading="lazy"
	
		alt="image-20230810132355346"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230810132019638.png"
	
	
	
	loading="lazy"
	
		alt="image-20230810132019638"
	
	
></p>
<p><strong>re_path 练习</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e"># 实现：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1.访问地址：http://127.0.0.1:8000/birthday/四位数字/一到两位数字/一到两位数字</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2.访问地址：http://127.0.0.1:8000/birthday/一到两位数字/一到两位数字/四位数字</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 访问路由页面展示：生日是 xxxx年 xx月 xx日</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># URL</span>
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># http://127.0.0.1:8000/birthday/四位数字/一到两位数字/一到两位数字</span>
</span></span><span style="display:flex;"><span>    re_path(<span style="color:#e6db74">&#39;birthday/(?P&lt;year&gt;\d</span><span style="color:#e6db74">{4}</span><span style="color:#e6db74">)/(?P&lt;month&gt;\d{1,2})/(?P&lt;day&gt;\d{1,2})$&#39;</span>, views<span style="color:#f92672">.</span>happy_birthday),
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># http://127.0.0.1:8000/birthday/一到两位数字/一到两位数字/四位数字</span>
</span></span><span style="display:flex;"><span>    re_path(<span style="color:#e6db74">&#39;birthday/(?P&lt;day&gt;\d{1,2})/(?P&lt;month&gt;\d{1,2})/(?P&lt;year&gt;\d</span><span style="color:#e6db74">{4}</span><span style="color:#e6db74">)$&#39;</span>, views<span style="color:#f92672">.</span>happy_birthday_2),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 视图函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">happy_birthday</span>(request, year, month, day):
</span></span><span style="display:flex;"><span>    html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;happy birthday </span><span style="color:#e6db74">{year}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{month}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{day}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(year<span style="color:#f92672">=</span>year, month<span style="color:#f92672">=</span>month, day<span style="color:#f92672">=</span>day)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">happy_birthday_2</span>(request, day, month, year):
</span></span><span style="display:flex;"><span>    html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;happy birthday 2 you : </span><span style="color:#e6db74">{day}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{month}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{year}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(day<span style="color:#f92672">=</span>day, month<span style="color:#f92672">=</span>month, year<span style="color:#f92672">=</span>year)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(html)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230810135933577.png"
	
	
	
	loading="lazy"
	
		alt="image-20230810135933577"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20230810140105975.png"
	
	
	
	loading="lazy"
	
		alt="image-20230810140105975"
	
	
></p>
<h2 id="5请求和响应">5.请求和响应</h2>
<h3 id="51-http-协议的请求和响应">5.1 HTTP 协议的请求和响应</h3>
<ul>
<li>请求是指浏览器端通过 HTTP 协议发送给服务器端的数据。</li>
<li>响应是指服务器端接收到请求后做相应的处理后再回复给浏览器端的数据。</li>
</ul>
<p>请求中的方法</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>序号</th>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>GET</td>
<td>请求指定的页面信息，并返回实体主体。</td>
</tr>
<tr>
<td>2</td>
<td>HEAD</td>
<td>类似于GET请求，只不过返回的响应中没有具体的内容，用于获取报头。</td>
</tr>
<tr>
<td>3</td>
<td>POST</td>
<td>向指定资源提交数据进行处理请求（例如提交表单或者上传文件），数据被包含在请求体中，POST请求可能会导致新的资源的建立和/或已有资源的修改。</td>
</tr>
<tr>
<td>4</td>
<td>PUT</td>
<td>从客户端向服务器传送的数据取代指定的文档内的内容。</td>
</tr>
<tr>
<td>5</td>
<td>DELETE</td>
<td>请求服务器删除指定的页面。</td>
</tr>
<tr>
<td>6</td>
<td>CONNECT</td>
<td>HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。</td>
</tr>
<tr>
<td>7</td>
<td>OPTIONS</td>
<td>允许客户端查看服务器的性能。</td>
</tr>
<tr>
<td>8</td>
<td>TRACE</td>
<td>回显服务器收到的请求，主要用于测或判断。</td>
</tr>
</tbody>
</table></div>
<h3 id="52-django中的请求">5.2 Django中的请求</h3>
<ul>
<li>请求在Django中实则就是视图函数的第一个参数，即HttpRequest对象。</li>
<li>Django接收到http协议的请求后，会根据请求数据报文创建HttpRequest对象。</li>
<li>HttpRequest对象通过属性描述了请求的所有相关信息。</li>
<li>path_info：url字符串。</li>
<li>methods：字符串，表示HTTP请求方法，常用值：<code>GET</code>、<code>POST</code>。</li>
<li>COOKIES：Python字典，包含所有的cookie，键和值都为字符串。</li>
<li>session：类似于字典的对接，表示当前的会话。</li>
<li>body：字符串，请求体的内容(POST或PUT)。</li>
<li>scheme：请求协议(&lsquo;http/https&rsquo;)。</li>
<li>request.get_full_path()：请求的完整路径。</li>
<li>request.META：请求中的元数据(消息头)。
<ul>
<li>request.META[&lsquo;REMOTE_ADDR&rsquo;]：客户端IP地址。</li>
</ul>
</li>
</ul>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240108094558431.png"
	
	
	
	loading="lazy"
	
		alt="image-20240108094558431"
	
	
></p>
<h3 id="53-响应">5.3 响应</h3>
<p>响应状态码的英文为<code>HTTP Status Code</code>，以下为常见的HTTP状态码：</p>
<ul>
<li>200，请求成功。</li>
<li>301，永久重定向，资源(网页等)被永久转移到其他URL。</li>
<li>302，临时重定向。</li>
<li>404，请求的资源(网页等)不存在。</li>
<li>500，内部服务器错误。</li>
</ul>
<p>HTTP状态码由三个十进制数字组成，第一个十进制数字定义了状态码的类型，后两个数字没有分类的作用，HTTP状态码共分为五种五种类型：</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>分类</th>
<th>分类描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1**</td>
<td>信息，服务器收到请求，需要请求者继续执行操作</td>
</tr>
<tr>
<td>2**</td>
<td>成功，操作被成功接收并处理</td>
</tr>
<tr>
<td>3**</td>
<td>重定向，需要进一步的操作以完成请求</td>
</tr>
<tr>
<td>4**</td>
<td>客户端错误，请求包含语法错误或无法完成请求</td>
</tr>
<tr>
<td>5**</td>
<td>服务器错误，服务器在处理请求的过程中发生了错误</td>
</tr>
</tbody>
</table></div>
<h3 id="54-django中的响应对象">5.4 Django中的响应对象</h3>
<p>构造函数格式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>HttpResponse(content<span style="color:#f92672">=</span>响应体,content_type<span style="color:#f92672">=</span>响应体数据类型,status<span style="color:#f92672">=</span>状态码)
</span></span></code></pre></div><p>作用：</p>
<p>向客户端浏览器返回响应，同时携带响应体内容。</p>
<p>常用的 <code>Content-Type</code> 如下：</p>
<ul>
<li><code>text/html</code>(默认的，html文件)</li>
<li><code>text/plain</code>(纯文本)</li>
<li><code>text/css</code>(css文件)</li>
<li><code>text/javascript</code>(javascript文件)</li>
<li><code>multipart/form-data</code>(文件提交)</li>
<li><code>application/json</code>(json传输)</li>
<li><code>application/xml</code>(xml文件)</li>
</ul>
<p>在编辑器中，使用不同的响应类即可。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240108100314014.png"
	
	
	
	loading="lazy"
	
		alt="image-20240108100314014"
	
	
></p>
<h3 id="55-get请求和post请求">5.5 GET请求和POST请求</h3>
<p><strong>定义</strong>：无论是 <code>GET</code> 还是 <code>POST</code>，统一都由视图函数接收请求，通过判断<code>request.method</code> 区分具体的请求动作。</p>
<p><strong>样例</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
</span></span><span style="display:flex;"><span>    处理GET请求时的业务逻辑
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span><span style="color:#960050;background-color:#1e0010">：</span>
</span></span><span style="display:flex;"><span>	处理POST请求时的业务逻辑
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    其他请求业务逻辑
</span></span></code></pre></div><h4 id="551-get处理">5.5.1 GET处理</h4>
<ul>
<li>
<p>GET请求动作，一般用于向服务器获取数据。</p>
</li>
<li>
<p>能够产生GET请求的场景：</p>
<ul>
<li>浏览器地址栏中输入<code>URL</code>，回车。</li>
<li><code>&lt;a href=&quot;地址?参数=值&amp;参数=值&quot;&gt;</code>。</li>
<li><code>form</code> 表单中的 <code>method</code>为 <code>get</code>。</li>
</ul>
</li>
<li>
<p>GET请求方式中，如果有数据需要传递给服务器，通常会用查询字符串(Query String)传递：</p>
<ul>
<li>
<p>URL格式：xxx?参数名1=值1&amp;参数名2=值2&hellip;</p>
<p>如：<code>http://127.0.0.1:8000/page1?a=100&amp;b=200</code></p>
</li>
<li>
<p>服务器端接收参数，获取客户端请求GET请求提交的数据。</p>
<p>方法示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>request<span style="color:#f92672">.</span>GET[<span style="color:#e6db74">&#39;参数名&#39;</span>]
</span></span><span style="display:flex;"><span>request<span style="color:#f92672">.</span>GET<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;参数名&#39;</span>,<span style="color:#e6db74">&#39;默认值&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 适用于参数有多个值的情况</span>
</span></span><span style="display:flex;"><span>request<span style="color:#f92672">.</span>GET<span style="color:#f92672">.</span>getlist(<span style="color:#e6db74">&#39;参数名&#39;</span>)
</span></span></code></pre></div></li>
</ul>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240108103057403.png"
	
	
	
	loading="lazy"
	
		alt="image-20240108103057403"
	
	
></p>
</li>
</ul>
<h4 id="552-post处理">5.5.2 POST处理</h4>
<ul>
<li>
<p>POST请求动作，一般用于向服务器提交大量/隐私数据。</p>
</li>
<li>
<p>客户端通过表单等POST请求将数据传递给服务器端，如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;post&#39;</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/login&#39;</span>&gt;
</span></span><span style="display:flex;"><span>    姓名:&lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;text&#39;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;username&#39;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;submit&#39;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;登陆&#39;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">form</span>&gt;
</span></span></code></pre></div></li>
<li>
<p>使用post方式接收客户端数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>request<span style="color:#f92672">.</span>POST[<span style="color:#e6db74">&#39;参数名&#39;</span>]
</span></span><span style="display:flex;"><span>request<span style="color:#f92672">.</span>POST<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;参数名&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>request<span style="color:#f92672">.</span>POST<span style="color:#f92672">.</span>getlist(<span style="color:#e6db74">&#39;参数名&#39;</span>)
</span></span></code></pre></div><p>POST请求需要取消CSRF验证，否则Django会拒绝客户端发来的POST请求，报403响应。<img src="/Django%E5%9F%BA%E7%A1%80/image-20240108104306814.png"
	
	
	
	loading="lazy"
	
		alt="image-20240108104306814"
	
	
></p>
<p>settings.py文件中，注释掉<code>django.middleware.csrf.CsrfViewMiddleware</code>。<img src="/Django%E5%9F%BA%E7%A1%80/image-20240108104613012.png"
	
	
	
	loading="lazy"
	
		alt="image-20240108104613012"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240108104452771.png"
	
	
	
	loading="lazy"
	
		alt="image-20240108104452771"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240108104918403.png"
	
	
	
	loading="lazy"
	
		alt="image-20240108104918403"
	
	
></p>
</li>
</ul>
<h2 id="6静态文件">6.静态文件</h2>
<ul>
<li>
<p>静态文件配置 - settings.py 中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 静态文件：CSS、JavaScript、Images</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 静态文件路由配置</span>
</span></span><span style="display:flex;"><span>STATIC_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/static/&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 静态文件存储路径配置</span>
</span></span><span style="display:flex;"><span>STATICFILES_DIRS <span style="color:#f92672">=</span> (os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(BASE_DIR,<span style="color:#e6db74">&#34;static&#34;</span>),)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 需要在指定的路径下创建static目录，存放静态文件进行访问</span>
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240119115354613.png"
	
	
	
	loading="lazy"
	
		alt="image-20240119115354613"
	
	
></p>
</li>
</ul>
<h2 id="7django应用及分布式路由">7.Django应用及分布式路由</h2>
<ul>
<li>应用在 Django 项目中是一个独立的业务模块，可以包含自己的路由、视图、模板、模型。</li>
</ul>
<h3 id="71-创建应用">7.1 创建应用</h3>
<ol>
<li>用 <code>manage.py</code> 中的子命令 <code>startapp</code> 创建应用文件夹。</li>
<li>在 <code>settings.py</code> 中的 <code>INSTALLED_APPS</code> 列表中配置安装此应用。<img src="/Django%E5%9F%BA%E7%A1%80/image-20240119133532831.png"
	
	
	
	loading="lazy"
	
		alt="image-20240119133532831"
	
	
></li>
</ol>
<h3 id="72-分布式路由">7.2 分布式路由</h3>
<p><code>Django</code> 中，主路由配置文件（urls.py）可以不处理用户具体路由，主路由配置文件可以做请求的分发（分布式请求处理），具体的请求可以由各自的应用来处理。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240119133731691.png"
	
	
	
	loading="lazy"
	
		alt="image-20240119133731691"
	
	
></p>
<p>分布式路由配置步骤：</p>
<ol>
<li>
<p>主路由中调用 <code>include</code> 函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 语法：inclued(&#39;app名称.url模块名&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 作用：用于将当前路由转到各个应用的路由配置文件的 urlpatterns 进行分布式处理</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 示例如下：</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path, re_path, include
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;admin/&#39;</span>, admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>urls),
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;demo/&#39;</span>, include(<span style="color:#e6db74">&#39;demo.urls&#39;</span>))
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
<li>
<p>应用下配置 <code>urls.py</code> 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 应用下手动创建urls.py 文件，内容结构同主路由完全一致</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> views
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;index&#39;</span>, views<span style="color:#f92672">.</span>index_view)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
<li>
<p>访问页面路由。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240119134544771.png"
	
	
	
	loading="lazy"
	
		alt="image-20240119134544771"
	
	
></p>
</li>
</ol>
<h2 id="8模型层及orm介绍">8.模型层及ORM介绍</h2>
<p><code>Django</code> 的 <code>MTV</code> 结构。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240119134709377.png"
	
	
	
	loading="lazy"
	
		alt="image-20240119134709377"
	
	
></p>
<h3 id="81-django-配置-mysql">8.1 Django 配置 mysql</h3>
<h4 id="811-依赖安装">8.1.1 依赖安装</h4>
<ul>
<li>
<p>安装 <code>mysqlclient</code> [版本 mysqlclient 1.3.13以上]</p>
</li>
<li>
<p>安装前需要确认 <code>ubuntu</code> 是否已安装 <code>python3-dev</code> 和 <code>default-libmysqlclient-dev</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python3-dev <span style="color:#75715e"># 1.检查安装第三方包的情况</span>
</span></span><span style="display:flex;"><span>sudo apt list --installed | grep -E <span style="color:#e6db74">&#39;libmysqlclient-dev|python3-dev&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2.未安装则进行安装</span>
</span></span><span style="display:flex;"><span>sudo apt install python3-dev default-libmysqlclient-dev
</span></span></code></pre></div></li>
<li>
<p>安装 <code>mysqlclient</code> 第三方包。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo pip3 install mysqlclient
</span></span></code></pre></div></li>
</ul>
<h4 id="812-django配置">8.1.2 Django配置</h4>
<ul>
<li>
<p>修改settings.py文件中 DATABASES 配置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DATABASES <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;default&#39;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;ENGINE&#39;</span>:<span style="color:#e6db74">&#39;django.db.backends.mysql&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;HOST&#39;</span>:<span style="color:#e6db74">&#39;host_ip&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;PORT&#39;</span>:<span style="color:#ae81ff">3306</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;USER&#39;</span>:<span style="color:#e6db74">&#39;username&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;PASSWORD&#39;</span>:<span style="color:#e6db74">&#39;password&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;NAME&#39;</span>:<span style="color:#e6db74">&#39;datanabaseNmae&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>执行数据库的迁移操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python manage.py migrate
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240123155958495.png"
	
	
	
	loading="lazy"
	
		alt="image-20240123155958495"
	
	
></p>
</li>
</ul>
<h4 id="813-迁移中出现的报错">8.1.3 迁移中出现的报错</h4>
<p>进行数据库迁移时，报错：SystemError: PY_SSIZE_T_CLEAN macro must be defined for ‘#’ formats，这个是Python3.10不兼容引起的，需要升级用到的 mysqlclient 包到最新版本。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240123154340874.png"
	
	
	
	loading="lazy"
	
		alt="image-20240123154340874"
	
	
></p>
<p>解决方法：升级<code>mysqlclient</code>到最新版。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240123154750086.png"
	
	
	
	loading="lazy"
	
		alt="image-20240123154750086"
	
	
></p>
<p>再次进行数据库迁移，正常无报错。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240123154957933.png"
	
	
	
	loading="lazy"
	
		alt="image-20240123154957933"
	
	
></p>
<h3 id="82-模型">8.2 模型</h3>
<h4 id="821-模型">8.2.1 模型</h4>
<ul>
<li>模型是一个Python类，它是由django.db.models.Model派生出的子类。</li>
<li>一个模型类代表数据库中的一张表。</li>
<li>模型类中每一个类属性都代表数据库中的一个字段。</li>
<li>模型是数据交互的接口，是表示和操作数据库的方法和方式。</li>
</ul>
<h4 id="822-orm框架">8.2.2 ORM框架</h4>
<ul>
<li>定义：ORM（Object Relational Mapping）即对象关系映射，它是一种程序技术，允许你使用类和对象对数据库进行操作，从而避免通过SQL语句操作数据库。</li>
<li>作用：
<ol>
<li>简历模型类和表之间的对应关系，允许我们通过面向对象的方式来操作数据库。</li>
<li>根据设计的模型类生成数据库中的表格。</li>
<li>通过简单的配置就可以进行数据库的切换。</li>
</ol>
</li>
<li>优点：
<ul>
<li>只需要面向对象编程，不需要面向数据库编写代码。</li>
<li>实现了数据模型与数据库的解耦，屏蔽了不同数据库操作上的差异。</li>
</ul>
</li>
</ul>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124113237393.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124113237393"
	
	
></p>
<!-- raw HTML omitted -->
<h4 id="823-orm框架使用">8.2.3 ORM框架使用</h4>
<ol>
<li>
<p>创建APP应用，创建的应用需要在settings.py中进行注册。</p>
<p>创建APP应用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python manage.py startapp bookstore
</span></span></code></pre></div><p>注册应用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>INSTALLED_APPS <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;bookstore&#39;</span>
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
<li>
<p>编写数据库ORM模型。</p>
<p>在 bookstore 应用的模型文件 models.py 中添加如下代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Books</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    title <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;书名&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    price <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>DecimalField(<span style="color:#e6db74">&#34;定价&#34;</span>, max_digits<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>, decimal_places<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>)
</span></span></code></pre></div></li>
<li>
<p>数据库迁移。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 生成迁移文件</span>
</span></span><span style="display:flex;"><span>python manage.py makemigrations
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行迁移脚本，同步数据库</span>
</span></span><span style="display:flex;"><span>python manage.py migrate
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124114021537.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124114021537"
	
	
></p>
</li>
</ol>
<h4 id="824-orm概念及操作">8.2.4 ORM概念及操作</h4>
<h5 id="8241-模型类定义">8.2.4.1 模型类定义</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> models
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">模型类名</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    字段名 <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>字段类型(字段选项)
</span></span></code></pre></div><h5 id="8242-基础字段">8.2.4.2 基础字段</h5>
<ul>
<li>BooleanField()
<ul>
<li>数据库类型：tinyint(1)</li>
<li>编程语言中：使用 True 或者False 来表示值</li>
<li>在数据库中：使用1或0来表示具体的值</li>
</ul>
</li>
<li>CharFild()
<ul>
<li>数据库类型：varchar</li>
<li>注意：必须要指定 max_length 参数值</li>
</ul>
</li>
<li>DateField()
<ul>
<li>数据库类型：date</li>
<li>作用：表示日期</li>
<li>参数：
<ol>
<li>auto_now：每次保存对象时，自动设置该字段为当前时间（取值：True/False）</li>
<li>auto_now_add：当对象第一次被创建时，自动设置当前时间（取值：True/False）</li>
<li>default：设置当前时间值（取值：字符串格式时间，如”2019-6-1“）</li>
</ol>
</li>
<li>以上三个参数只能多选一。</li>
</ul>
</li>
<li>DateTimeField()
<ul>
<li>数据库类型：datetime(6)</li>
<li>作用：表示日期和时间</li>
<li>参数同 DateField</li>
</ul>
</li>
<li>FloatField()
<ul>
<li>数据库类型：double</li>
<li>编程语言和数据库中都是用小数表示值</li>
</ul>
</li>
<li>DecimalField()
<ul>
<li>数据库类型：decimal(x,y)</li>
<li>编程语言中：使用小数表示该列的值</li>
<li>在数据库中：使用小数</li>
<li>参数：
<ul>
<li>max_digits：位数总数，包括小数点后的位数，该数必须大于等于decimal_palces</li>
<li>decimal_places：小数点后的数字数量</li>
</ul>
</li>
</ul>
</li>
<li>EmailField()
<ul>
<li>数据库类型：varchar</li>
<li>编程语言和数据库中使用字符串</li>
</ul>
</li>
<li>IntegerField()
<ul>
<li>数据库类型：int</li>
<li>编程语言和数据库中使用整数</li>
</ul>
</li>
<li>ImageField()
<ul>
<li>数据库类型：varchar(100)</li>
<li>作用：在数据库中为了保存图片的路径</li>
<li>编程语言和数据库中使用字符串</li>
</ul>
</li>
<li>TextField()
<ul>
<li>数据库类型：longtext</li>
<li>作用：表示不定长的字符数据</li>
</ul>
</li>
</ul>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Author</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;姓名&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">11</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>IntegerField(<span style="color:#e6db74">&#34;年龄&#34;</span>)
</span></span><span style="display:flex;"><span>    emal <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>EmailField(<span style="color:#e6db74">&#34;邮箱&#34;</span>)
</span></span></code></pre></div><h5 id="8243-字段选项">8.2.4.3 字段选项</h5>
<ul>
<li>字段选项，指定创建的列的额外的信息</li>
<li>允许出现多个字段选项，多个选项之间使用 <code>,</code> 隔开</li>
<li>注：字段选项的官方文档地址（https://docs.djangoproject.com/en/2.2/ref/models/fields/#field-options）</li>
<li>primary_key
<ul>
<li>如果设置为 True，表示该列为主键，如果指定一个字段为主键，则此数据库表不会创建 id 字段。</li>
</ul>
</li>
<li>blank
<ul>
<li>设置为 True 时，字段可以为空，设置为 False 时，字段为必填项。</li>
</ul>
</li>
<li>null
<ul>
<li>如果设置为 True，表示该列值允许为空。</li>
<li>默认为 False，如果此选项为False，建议加入 default 选项来设置默认值。</li>
</ul>
</li>
<li>default
<ul>
<li>设置所在列的默认值，如果字段选项 null = False，建议添加此项。</li>
</ul>
</li>
<li>db_index
<ul>
<li>如果设置为 True，表示为该列增加索引</li>
</ul>
</li>
<li>unique
<ul>
<li>如果设置为 True，表示该字段在数据库中的值必须是独一无二的。</li>
</ul>
</li>
<li>db_column
<ul>
<li>指定列的名称，如果不指定的话则采用属性名作为列名。</li>
</ul>
</li>
<li>verbose_name
<ul>
<li>设置此字段在 admin 界面上显示的名称。</li>
</ul>
</li>
</ul>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 创建一个属性，表示用户名称，长度40个字符，必须是唯一的，不能为空，添加索引</span>
</span></span><span style="display:flex;"><span>name <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;用户名称&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">40</span>, unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, null<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>, db_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h5 id="8244-meta类">8.2.4.4 Meta类</h5>
<ul>
<li>使用内部Meta类，来给模型赋予属性，Meta类下有很多内建的类属性，可对模型类做一些控制。</li>
<li>db_table，修改当前模型对应的表名。</li>
<li>unique_together，用于组合多个字段，这些字段组成的值，在数据表中是独一无二的。</li>
<li>注：Meta类官方文档（https://docs.djangoproject.com/zh-hans/2.2/ref/models/options/）</li>
</ul>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Books</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    title <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;书名&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    price <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>DecimalField(<span style="color:#e6db74">&#34;定价&#34;</span>, max_digits<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>, decimal_places<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>)
</span></span><span style="display:flex;"><span>    info <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;描述&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
</span></span><span style="display:flex;"><span>        db_table <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;book&#39;</span> <span style="color:#75715e"># 可以改变当前模型类对应的表名</span>
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124132657474.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124132657474"
	
	
></p>
<h5 id="8245-创建数据">8.2.4.5 创建数据</h5>
<p>Django ORM 使用一种直观的方式把数据库表中的数据表示成 Python 对象。</p>
<p>创建数据中每一条记录就是创建一个数据对象。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 方法一</span>
</span></span><span style="display:flex;"><span>MyModel<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(属性1<span style="color:#f92672">=</span>值1,属性2<span style="color:#f92672">=</span>值2,<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 成功：返回创建好的实体对象</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 失败：抛出异常</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方法二</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建MyModel 实例对象，并调用 save() 进行保存</span>
</span></span><span style="display:flex;"><span>obj <span style="color:#f92672">=</span> MyModel(属性<span style="color:#f92672">=</span>值)
</span></span><span style="display:flex;"><span>obj<span style="color:#f92672">.</span>属性 <span style="color:#f92672">=</span> 值
</span></span><span style="display:flex;"><span>obj<span style="color:#f92672">.</span>save()
</span></span></code></pre></div><p>Django提供了一个交互式的操作项目叫 Django Shell，它能够在交互模式用项目工程的代码执行相应的操作。</p>
<p>注意：项目代码发生变化时，需要重新进入Django Shell。</p>
<p>启动方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python manage.py shell
</span></span></code></pre></div><p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bookstore.models <span style="color:#f92672">import</span> Books
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方式一</span>
</span></span><span style="display:flex;"><span>Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;大江大河&#39;</span>, price<span style="color:#f92672">=</span><span style="color:#ae81ff">53.00</span>, info<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;大江大河&#39;</span>, pub<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;东海工业出版社&#39;</span>, market_price<span style="color:#f92672">=</span><span style="color:#ae81ff">55.00</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方式二</span>
</span></span><span style="display:flex;"><span>bookObj <span style="color:#f92672">=</span> Books(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Django入门教程&#39;</span>, price<span style="color:#f92672">=</span><span style="color:#ae81ff">53.00</span>, info<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;大江大河&#39;</span>, pub<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;清华大学出版社&#39;</span>, market_price<span style="color:#f92672">=</span><span style="color:#ae81ff">55.00</span>)
</span></span><span style="display:flex;"><span>bookObj<span style="color:#f92672">.</span>info <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Django入门教程&#39;</span>
</span></span><span style="display:flex;"><span>bookObj<span style="color:#f92672">.</span>save()
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124135252237.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124135252237"
	
	
></p>
<p>数据库中对应出现两条记录。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124135355074.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124135355074"
	
	
></p>
<h5 id="8246-查询方法">8.2.4.6 查询方法</h5>
<ul>
<li>
<p>数据库的查询需要使用管理器对象进行。</p>
</li>
<li>
<p>通过 MyModel.objects 管理器方法调用查询方法。</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>all()</td>
<td>查询全部记录，返回QuerySet查询对象</td>
</tr>
<tr>
<td>get()</td>
<td>查询符合条件的单一记录</td>
</tr>
<tr>
<td>filter()</td>
<td>查询符合条件的多条记录</td>
</tr>
<tr>
<td>exclude()</td>
<td>查询符合条件之外的全部记录</td>
</tr>
</tbody>
</table></div>
</li>
<li>
<p>all()方法</p>
<p>用法：MyModel.objects.all()</p>
<p>作用：查询 MyModel 实体中所有的数据，等同于 select * from table</p>
<p>返回值：QuerySet 容器对象，内部存放 MyModel 实例</p>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bookstore.models <span style="color:#f92672">import</span> Books
</span></span><span style="display:flex;"><span>books <span style="color:#f92672">=</span> Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> book <span style="color:#f92672">in</span> books:
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;书名&#34;</span>,book<span style="color:#f92672">.</span>title, <span style="color:#e6db74">&#34;出版社&#34;</span>, book<span style="color:#f92672">.</span>pub)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124214503814.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124214503814"
	
	
></p>
<p>也可以在 ORM 模型中定义<code> __str__</code> 方法，直接返回表中的信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Books</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    title <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;书名&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>, unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    price <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>DecimalField(<span style="color:#e6db74">&#34;定价&#34;</span>, max_digits<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>, decimal_places<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>)
</span></span><span style="display:flex;"><span>    info <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;描述&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    pub <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;出版社&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, null<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    market_price <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>DecimalField(<span style="color:#e6db74">&#34;图书零售价&#34;</span>, max_digits<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>, decimal_places<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 可以改变当前模型类对应的表名</span>
</span></span><span style="display:flex;"><span>        db_table <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;book&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __str__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (self<span style="color:#f92672">.</span>title, self<span style="color:#f92672">.</span>info, self<span style="color:#f92672">.</span>pub, self<span style="color:#f92672">.</span>market_price)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124215031402.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124215031402"
	
	
></p>
</li>
<li>
<p>values(&lsquo;列1&rsquo;,&lsquo;列2&rsquo;)</p>
<p>用法：MyModel.objects.values(&hellip;)</p>
<p>作用：查询部分列的数据并返回，等同于 select 列1，列2 from table</p>
<p>返回值：QuerySet，返回查询结果容器，容器内存字典，每个字典代表一条数据，格式为：{&lsquo;列1&rsquo;:&lsquo;值1&rsquo;,&lsquo;列2&rsquo;:&lsquo;值2&rsquo;}</p>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bookstore.models <span style="color:#f92672">import</span> Books
</span></span><span style="display:flex;"><span>books <span style="color:#f92672">=</span> Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>values(<span style="color:#e6db74">&#39;title&#39;</span>,<span style="color:#e6db74">&#39;pub&#39;</span>)
</span></span><span style="display:flex;"><span>print(books)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124215602575.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124215602575"
	
	
></p>
</li>
<li>
<p>values_list(&lsquo;列1&rsquo;,&lsquo;列2&rsquo;)</p>
<p>用法：MyModel.objects.values_list(&hellip;)</p>
<p>作用：返回元组形式的查询结果，等同于select 列1,列2 from table</p>
<p>返回值：QuerySet 容器对象，内存存放元组。</p>
<p>会将查询出来的数据封装到元组中，再封装到查询集合 QuerySet 中。</p>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>books <span style="color:#f92672">=</span> Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>values_list(<span style="color:#e6db74">&#39;title&#39;</span>,<span style="color:#e6db74">&#39;pub&#39;</span>)
</span></span><span style="display:flex;"><span>print(books)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124215939781.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124215939781"
	
	
></p>
</li>
<li>
<p>order_by()</p>
<p>用法：MyModel.objects.order_by(&rsquo;-列&rsquo;,&lsquo;列&rsquo;)</p>
<p>作用：与 all() 方法不同，它会用 SQL 语句的 ORDER BY 子句对查询结果进行根据某个字段选择性的进行排序。</p>
<p>说明：默认是按照升序排序，降序排序则需要在列前增加 <code>-</code> 表示。</p>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bookstore.models <span style="color:#f92672">import</span> Books
</span></span><span style="display:flex;"><span>books <span style="color:#f92672">=</span> Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>order_by(<span style="color:#e6db74">&#39;title&#39;</span>)
</span></span><span style="display:flex;"><span>print(books)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>books <span style="color:#f92672">=</span> Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>order_by(<span style="color:#e6db74">&#39;-title&#39;</span>)
</span></span><span style="display:flex;"><span>print(books)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124220636265.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124220636265"
	
	
></p>
</li>
<li>
<p>filter(条件)</p>
<p>语法：MyModel.objects.filter(属性1=值1,属性2=值2)</p>
<p>作用：返回包含此条件的全部数据集</p>
<p>返回值：QuerySet 容器对象，内部存放 MyModel 示例</p>
<p>说明：当多个属性在一起时为 &ldquo;与&rdquo; 关系</p>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 查询书中出版社为&#34;清华大学出版社&#34;的图书</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bookstore.models <span style="color:#f92672">import</span> Books
</span></span><span style="display:flex;"><span>books <span style="color:#f92672">=</span> Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(pub<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;清华大学出版社&#39;</span>)
</span></span><span style="display:flex;"><span>print(books)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查询Author实体中name为王老师并且年龄为28岁的</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bookstore.models <span style="color:#f92672">import</span> Author
</span></span><span style="display:flex;"><span>authores <span style="color:#f92672">=</span> Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>print(authores)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>authores <span style="color:#f92672">=</span> Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;王老师&#39;</span>,age<span style="color:#f92672">=</span><span style="color:#ae81ff">28</span>)
</span></span><span style="display:flex;"><span>print(authores)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124222243402.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124222243402"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124222115904.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124222115904"
	
	
></p>
</li>
<li>
<p>exclude(条件)</p>
<p>语法：MyModel.objects.exclude(条件)</p>
<p>作用：返回不包含此条件的全部数据集</p>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bookstore.models <span style="color:#f92672">import</span> Author,Books
</span></span><span style="display:flex;"><span>books <span style="color:#f92672">=</span> Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>exclude(pub<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;清华大学出版社&#39;</span>)
</span></span><span style="display:flex;"><span>print(books)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124223219617.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124223219617"
	
	
></p>
</li>
<li>
<p>get(条件)</p>
<p>语法：MyModel.objects.get(条件)</p>
<p>作用：返回满足条件的唯一数据</p>
<p>说明：该方法只能返回一条数据，查询结果多于一条数据则抛出 <code>Model.MultipleObjectsReturned</code> 异常，查询结果如果没有数据则抛出 <code>Model.DoesNotExist</code> 异常</p>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124223717187.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124223717187"
	
	
></p>
</li>
</ul>
<h5 id="8247-查询谓词">8.2.4.7 查询谓词</h5>
<p>定义：做更灵活的条件查询时需要使用查询谓词。</p>
<p>说明：每一个查询谓词是一个独立的查询功能。</p>
<ul>
<li>
<p>__exact，等值匹配</p>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(id__exact<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 等同于 select * from author where id = 1</span>
</span></span></code></pre></div></li>
<li>
<p>__contains，包含指定值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Books<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(name__contains<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Python&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 等同于 select * from books where name link &#39;%Python%&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>__startswith，以 xxx 开始</p>
</li>
<li>
<p>__endswith，以 xxx 结束</p>
</li>
<li>
<p>__gt，大于指定值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(age__gt<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 等同于 select * from author where age &gt; 50</span>
</span></span></code></pre></div></li>
<li>
<p>__gte，大于等于</p>
</li>
<li>
<p>__lt，小于</p>
</li>
<li>
<p>__lte，小于等于</p>
</li>
<li>
<p>__in，查找数据是否在指定范围内</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(country__in<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;中国&#39;</span>,<span style="color:#e6db74">&#39;日本&#39;</span>,<span style="color:#e6db74">&#39;韩国&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 等同于 select * from author where country in (&#39;中国&#39;,&#39;日本&#39;,&#39;韩国&#39;)</span>
</span></span></code></pre></div></li>
<li>
<p>__range，查找数据是否在指定的区间范围内</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 查找年龄在某一区间内的所有作者</span>
</span></span><span style="display:flex;"><span>Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(age__range<span style="color:#f92672">=</span>(<span style="color:#ae81ff">35</span>,<span style="color:#ae81ff">50</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 等同于 select * from author where age between 35 and 50</span>
</span></span></code></pre></div></li>
</ul>
<h5 id="8248-更新操作">8.2.4.8 更新操作</h5>
<ul>
<li>
<p>修改单个实体的某些字段值的步骤：</p>
<ul>
<li>查，通过 get() 得到要修改的实体对象。</li>
<li>改，通过 对象.属性 的方式修改数据。</li>
<li>保存，通过 对象.save() 保存数据。</li>
</ul>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124231329221.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124231329221"
	
	
></p>
</li>
<li>
<p>批量更新数据</p>
<ul>
<li>直接调用 QuerySet 的 update(属性=值) 实现批量修改</li>
</ul>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124231621418.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124231621418"
	
	
></p>
</li>
</ul>
<h5 id="8249-删除操作">8.2.4.9 删除操作</h5>
<ul>
<li>
<p>单个数据删除的步骤：</p>
<ul>
<li>查找查询结果对应的一个数据对象</li>
<li>调用这个数据对象的 delete() 方法实现删除。</li>
</ul>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124231847751.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124231847751"
	
	
></p>
</li>
<li>
<p>批量删除的步骤：</p>
<ul>
<li>查找查询结果集中满足条件的全部 QuerySet 查询集合对象</li>
<li>调用查询集合对象的 delete() 方法实现删除</li>
</ul>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124232229707.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124232229707"
	
	
></p>
</li>
<li>
<p>伪查询</p>
<ul>
<li>通常不会轻易在业务里把数据真正删掉，取而代之的是做伪删除，即在表中添加一个布尔型字段（is_active），默认是True，执行删除时，将欲删除数据的 is_active 字段设置为 False。</li>
<li>注意：用伪删除时，确保显示数据的地方，均添加了 is_active = True 的过滤查询。</li>
</ul>
</li>
</ul>
<h5 id="82410-f对象和q对象">8.2.4.10 F对象和Q对象</h5>
<p><strong>F对象</strong></p>
<ul>
<li>
<p>一个F对象代表数据库中某条记录的字段的信息</p>
</li>
<li>
<p>作用：</p>
<ul>
<li>通常是对数据库中的字段值在不获取的情况下进行操作</li>
<li>用于类属性（字段）之间的比较</li>
</ul>
</li>
<li>
<p>语法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db.models <span style="color:#f92672">import</span> F
</span></span><span style="display:flex;"><span>F(<span style="color:#e6db74">&#39;列名&#39;</span>)
</span></span></code></pre></div></li>
<li>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 示例1：更新Book示例中所有的零售价涨10元</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db.models <span style="color:#f92672">import</span> F
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bookstore.models <span style="color:#f92672">import</span> Book
</span></span><span style="display:flex;"><span>Book<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()<span style="color:#f92672">.</span>update(market_price<span style="color:#f92672">=</span>F(<span style="color:#e6db74">&#39;market_price&#39;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">10</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124233659683.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124233659683"
	
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 示例2：对数据库中两个字段的值进行比较，列出那些书的零售价高于定价</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db.models <span style="color:#f92672">import</span> F
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bookstore.models <span style="color:#f92672">import</span> Book
</span></span><span style="display:flex;"><span>Book<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(market_price__gt<span style="color:#f92672">=</span>F(<span style="color:#e6db74">&#39;price&#39;</span>))
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240124234128957.png"
	
	
	
	loading="lazy"
	
		alt="image-20240124234128957"
	
	
></p>
</li>
</ul>
<p><strong>Q对象</strong></p>
<ul>
<li>
<p>当在获取查询结果集使用复杂的逻辑或|、逻辑非 ~ 等操作时可以借助Q对象进行操作</p>
</li>
<li>
<p>作用：在条件中用来实现除 and(&amp;) 以外的 or(|) 或 not(~) 操作</p>
</li>
<li>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db.models <span style="color:#f92672">import</span> Q
</span></span><span style="display:flex;"><span>Q(条件1)<span style="color:#f92672">|</span>(Q条件2) <span style="color:#75715e"># 条件1成立或条件2成立</span>
</span></span><span style="display:flex;"><span>Q(条件1)<span style="color:#f92672">&amp;</span>Q(条件2) <span style="color:#75715e"># 条件1和条件2同时成立</span>
</span></span><span style="display:flex;"><span>Q(条件1)<span style="color:#f92672">&amp;~</span>Q(条件2) <span style="color:#75715e"># 条件1成立且条件2不成立</span>
</span></span></code></pre></div></li>
<li>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 示例1：查找清华大学出版社的书或价格低于50的书</span>
</span></span><span style="display:flex;"><span>Book<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(Q(pub<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;清华大学出版社&#39;</span>)<span style="color:#f92672">|</span>Q(price__lt<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 示例2：查找不···	是机械出版社且价格低于50的书</span>
</span></span><span style="display:flex;"><span>Book<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(Q(price__lt<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>)<span style="color:#f92672">|~</span>Q(pub<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;清华大学出版社&#39;</span>))
</span></span></code></pre></div></li>
</ul>
<h5 id="82411-聚合查询和原生数据库操作">8.2.4.11 聚合查询和原生数据库操作</h5>
<p><strong>聚合查询</strong></p>
<p>聚合查询是指对一个数据表中的一个字段的数据进行部分或全部进行统计查询，查 bookstore 数据表中的全部书的平均价格，查询所有书的总个数等，都要使用聚合查询。</p>
<p>聚合查询分为：整表聚合、分组聚合</p>
<p><strong>聚合查询 - 整表聚合</strong></p>
<p>不带分组的聚合查询是指将全部数据进行集中统计查询。</p>
<p>聚合函数[需要导入]：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 导入方法</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db.models <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 聚合函数：Sum、Avg、Count、Max、Min</span>
</span></span></code></pre></div><p>语法：MyModel.objects.aggregate(结果变量名=聚合函数(&lsquo;列&rsquo;))</p>
<p>返回结果：结果变量名和值组成的字典，格式为：{&lsquo;结果变量名&rsquo;:值}</p>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125074907149.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125074907149"
	
	
></p>
<p><strong>聚合查询 - 分组聚合</strong></p>
<p>分组聚合是指通过计算查询结果中每一个对象所关联的对象集合，从而得出总计值（也可以是平均值或总和），即为查询集的每一项生成聚合。</p>
<p>语法：QuerySet.annotate(结果变量名=聚合函数(&lsquo;列&rsquo;))</p>
<p>返回值：QuerySet</p>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125080525797.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125080525797"
	
	
></p>
<p><strong>原生数据库操作</strong></p>
<p>Django 页可以支持直接使用SQL语句的方式通信数据库。</p>
<p>查询：使用 MyModel.objects.raw() 进行数据库的查询操作。</p>
<p>语法：MyModel.objects.raw(sql语句，拼接参数)</p>
<p>返回值：RawQuery 集合对象，只支持基础的操作，比如循环</p>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125081249994.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125081249994"
	
	
></p>
<p><strong>原生数据库操作 - SQL注入</strong></p>
<p>使用原生语句时小心SQL注入。</p>
<p>定义：用户通过数据上传，将恶意的SQL语句提交给服务器，从而达到攻击效果。</p>
<p>案例1：用户在搜索图表的SQL传入 <code>1 or 1=1</code>，可以查询出所有的图书数据。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125081701040.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125081701040"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125081723909.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125081723909"
	
	
></p>
<p><strong>SQL注入防范</strong></p>
<p>错误 -&gt; s1 = Book.objects.raw(&lsquo;select * from book where id = %s&rsquo;%(&lsquo;1 or 1=1&rsquo;))</p>
<p>正确 -&gt; s1 = Book.objects.raw(&lsquo;select * from book where id = %s&rsquo;,[&lsquo;1 or 1=1&rsquo;])</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125081958288.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125081958288"
	
	
></p>
<p><strong>原生数据库操作 - cursor</strong></p>
<p>完全跨过模型类操作数据库 - 查询/更新/删除</p>
<ol>
<li>
<p>导入 <code>cursor</code> 所在的包。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> connection
</span></span></code></pre></div></li>
<li>
<p>用创建 <code>cursor</code> 类的构造函数创建 <code>cursor</code> 对象，再使用 <code>cursor</code> 对象，为保证在出现异常时能释放 <code>cursor</code> 资源，通常使用 <code>with</code> 语句进行创建操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> connection
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> connection<span style="color:#f92672">.</span>cursor() <span style="color:#66d9ef">as</span> cur:
</span></span><span style="display:flex;"><span>    cur<span style="color:#f92672">.</span>excute(<span style="color:#e6db74">&#39;执行SQL语句&#39;</span>,<span style="color:#e6db74">&#39;拼接参数&#39;</span>)
</span></span></code></pre></div></li>
</ol>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125082736075.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125082736075"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125082824840.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125082824840"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125083222994.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125083222994"
	
	
></p>
<p>原生SQL查询防止SQL注入</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125083401086.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125083401086"
	
	
></p>
<h2 id="9admin后台管理">9.admin后台管理</h2>
<ul>
<li>django 提供了比较完善的后台管理数据库的接口，可供开发过程中的调用和测试使用。</li>
<li>django 会搜集所有已注册的模型类，为这些模型类提供数据管理界面，供开发者使用。</li>
</ul>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125103018596.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125103018596"
	
	
></p>
<h3 id="91-admin-配置步骤">9.1 Admin 配置步骤</h3>
<ol>
<li>
<p>创建后台管理账号，该账号为后台管理最高权限的账号</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python3 manage.py createsuperuser
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125103323005.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125103323005"
	
	
></p>
</li>
<li>
<p>使用创建的用户登录管理后台。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125103413255.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125103413255"
	
	
></p>
</li>
</ol>
<h3 id="92-注册自定义模型类">9.2 注册自定义模型类</h3>
<p>如果需要将自己定义的模型类也能在 /admin 后台管理中显示和管理，需要将自己的类注册到后台管理界面。</p>
<p>注册步骤：</p>
<ol>
<li>
<p>在应用中的 admin.py 中导入注册要管理的模型 models 类，如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> .models <span style="color:#f92672">import</span> Book
</span></span></code></pre></div></li>
<li>
<p>调用 admin.site.register 方法进行注册，如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>register(自定义模型类)
</span></span></code></pre></div></li>
</ol>
<p>代码示例：</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125104514186.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125104514186"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125104557201.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125104557201"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125104613120.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125104613120"
	
	
></p>
<h3 id="93-模型管理器类">9.3 模型管理器类</h3>
<p>作用：为后台管理界面添加便于操作的新功能。</p>
<p>说明：后台管理器类必须继承自 django.contrib.admin 里的 ModelAdmin类。</p>
<p>使用方法：</p>
<ol>
<li>
<p>在 [应用]/admin.py 里定义模型管理类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">xxxManager</span>(admin<span style="color:#f92672">.</span>ModelAdmin):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span></code></pre></div></li>
<li>
<p>绑定注册模型管理器和模型类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib <span style="color:#f92672">import</span> admin
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .models <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>register(YYYY,xxxManager)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 绑定 YYY模型类与xxxManager管理器类</span>
</span></span></code></pre></div></li>
</ol>
<p>代码示例1：信息展示</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib <span style="color:#f92672">import</span> admin
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .models <span style="color:#f92672">import</span> Book
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Register your models here.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookManager</span>(admin<span style="color:#f92672">.</span>ModelAdmin):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 列表页显示哪些字段的列</span>
</span></span><span style="display:flex;"><span>    list_display <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;title&#39;</span>, <span style="color:#e6db74">&#39;pub&#39;</span>, <span style="color:#e6db74">&#39;price&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>register(Book, BookManager)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125105402325.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125105402325"
	
	
></p>
<p>代码示例2：信息修改</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib <span style="color:#f92672">import</span> admin
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .models <span style="color:#f92672">import</span> Book
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Register your models here.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># admin.site.register(Book)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookManager</span>(admin<span style="color:#f92672">.</span>ModelAdmin):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 列表页显示哪些字段的列</span>
</span></span><span style="display:flex;"><span>    list_display <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;title&#39;</span>, <span style="color:#e6db74">&#39;pub&#39;</span>, <span style="color:#e6db74">&#39;price&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 点击那个字段能够进入信息的修改页面</span>
</span></span><span style="display:flex;"><span>    list_display_links <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;title&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>register(Book, BookManager)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125105623582.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125105623582"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125105706271.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125105706271"
	
	
></p>
<p>代码示例3：过滤器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib <span style="color:#f92672">import</span> admin
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .models <span style="color:#f92672">import</span> Book
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Register your models here.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># admin.site.register(Book)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookManager</span>(admin<span style="color:#f92672">.</span>ModelAdmin):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 列表页显示哪些字段的列</span>
</span></span><span style="display:flex;"><span>    list_display <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;title&#39;</span>, <span style="color:#e6db74">&#39;pub&#39;</span>, <span style="color:#e6db74">&#39;price&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 点击那个字段能够进入信息的修改页面</span>
</span></span><span style="display:flex;"><span>    list_display_links <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;title&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 添加过滤器</span>
</span></span><span style="display:flex;"><span>    list_filter <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;pub&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>register(Book, BookManager)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125110916475.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125110916475"
	
	
></p>
<p>代码示例4：搜索框</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib <span style="color:#f92672">import</span> admin
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .models <span style="color:#f92672">import</span> Book
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Register your models here.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># admin.site.register(Book)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookManager</span>(admin<span style="color:#f92672">.</span>ModelAdmin):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 列表页显示哪些字段的列</span>
</span></span><span style="display:flex;"><span>    list_display <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;title&#39;</span>, <span style="color:#e6db74">&#39;pub&#39;</span>, <span style="color:#e6db74">&#39;price&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 点击那个字段能够进入信息的修改页面</span>
</span></span><span style="display:flex;"><span>    list_display_links <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;title&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 添加过滤器</span>
</span></span><span style="display:flex;"><span>    list_filter <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;pub&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 添加搜索框[模糊查询]</span>
</span></span><span style="display:flex;"><span>    search_fields <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;title&#39;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>register(Book, BookManager)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125111051469.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125111051469"
	
	
></p>
<p>代码示例5：页面可编辑的字段</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib <span style="color:#f92672">import</span> admin
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .models <span style="color:#f92672">import</span> Book
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Register your models here.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># admin.site.register(Book)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookManager</span>(admin<span style="color:#f92672">.</span>ModelAdmin):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 列表页显示哪些字段的列</span>
</span></span><span style="display:flex;"><span>    list_display <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;title&#39;</span>, <span style="color:#e6db74">&#39;pub&#39;</span>, <span style="color:#e6db74">&#39;price&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 点击那个字段能够进入信息的修改页面</span>
</span></span><span style="display:flex;"><span>    list_display_links <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;title&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 添加过滤器</span>
</span></span><span style="display:flex;"><span>    list_filter <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;pub&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 添加搜索框[模糊查询]</span>
</span></span><span style="display:flex;"><span>    search_fields <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;title&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 添加页面可编辑的字段</span>
</span></span><span style="display:flex;"><span>    list_editable <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;price&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin<span style="color:#f92672">.</span>site<span style="color:#f92672">.</span>register(Book, BookManager)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240125111226382.png"
	
	
	
	loading="lazy"
	
		alt="image-20240125111226382"
	
	
></p>
<h2 id="10关系映射">10.关系映射</h2>
<p>在关系型数据库中，通常不会把所有数据都放在同一张表中，不易于扩展，常见的关系映射有：</p>
<ol>
<li>一对一映射，如一个身份证对应一个人。</li>
<li>一对多映射，如一个班级可以有多个学生。</li>
<li>多对多映射，如一个学生可以报多个课程，一个课程可以有多个学生学习。</li>
</ol>
<h3 id="101-一对一映射">10.1 一对一映射</h3>
<h4 id="1011-一对一映射定义">10.1.1 一对一映射定义</h4>
<ul>
<li>一对一是表示现实事物间存在的一对一的对应关系。如：一个家庭只有一个户主，一个男人有一个妻子，一个人有一个唯一的身份证号等。</li>
</ul>
<h4 id="1012-一对一映射创建模型">10.1.2 一对一映射创建模型</h4>
<ul>
<li>
<p>语法：OneToOneField(类名，on_delete=xxx)，on_delete：级联删除。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>(model<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span>(model<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    属性 <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>OneToOneField(A, on_delete<span style="color:#f92672">=</span>xxx)
</span></span></code></pre></div></li>
<li>
<p>特殊字段选项【必须】，on_delete，级联删除。</p>
</li>
</ul>
<p>Django中的一对一映射</p>
<ol>
<li>models.CASCADE 级联删除，Django模拟SQL约束ON DELETE CASCADE的行为，并删除包含ForegnKey的对象。</li>
<li>models.PROTECT 抛出ProtectedError 以组织被引用对象的删除，等同于 mysql 默认的RESTRICT。</li>
<li>SET_NULL 设置 ForeignKey null，需要指定 null=True；</li>
<li>SET_DEFAULT 将 ForeignKey 设置为其默认值，必须设置ForeignKey默认值。</li>
</ol>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> models
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关系说明：一个人只有一个身份证号码，一个身份证号码对应一个人</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create your models here.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Person</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    个人类
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;姓名&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">11</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>, null<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>IntegerField(<span style="color:#e6db74">&#34;年龄&#34;</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    home <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;住址&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">256</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __str__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (self<span style="color:#f92672">.</span>name, self<span style="color:#f92672">.</span>age, self<span style="color:#f92672">.</span>email)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IdCard</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    身份证件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    idCardNUmber <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;身份证号码&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, null<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    person <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>OneToOneField(Person, on_delete<span style="color:#f92672">=</span>models<span style="color:#f92672">.</span>CASCADE) <span style="color:#75715e"># 一对一属性</span>
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203140651540.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203140651540"
	
	
></p>
<h4 id="1013-一对一映射创建数据">10.1.3 一对一映射创建数据</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 无外键的模型类[Person]:</span>
</span></span><span style="display:flex;"><span>person <span style="color:#f92672">=</span> Person<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;南歌&#39;</span>, age<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, home<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;陕西省延安市&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 有外键的模型类[IdCard]</span>
</span></span><span style="display:flex;"><span>idcard <span style="color:#f92672">=</span> IdCard<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(idCardNUmber<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xxxx&#39;</span>, person<span style="color:#f92672">=</span>person)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 也即关联个人的主键值</span>
</span></span><span style="display:flex;"><span>idcard <span style="color:#f92672">=</span> IdCard<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(idCardNUmber<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xxxx&#39;</span>, person_id<span style="color:#f92672">=</span>person_id)
</span></span></code></pre></div><p>直接关联外键对应的对象。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203142124625.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203142124625"
	
	
></p>
<p>数据库查看。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203141621367.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203141621367"
	
	
></p>
<p>关联外键对应对象的主键值。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203142058673.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203142058673"
	
	
></p>
<p>数据库查看。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203142039521.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203142039521"
	
	
></p>
<h4 id="1014-一对一映射查询数据">10.1.4 一对一映射查询数据</h4>
<ol>
<li>
<p>正向查询：直接通过关联的外键属性查询，则称为正向查询。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 通过IdCard查找Person</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> oto.models <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>idCard <span style="color:#f92672">=</span> IdCard<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(idCardNUmber<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xxxx&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;身份证号：</span><span style="color:#e6db74">{idCardNUmber}</span><span style="color:#e6db74">的人姓名为：</span><span style="color:#e6db74">{name}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(idCardNUmber<span style="color:#f92672">=</span>idCard<span style="color:#f92672">.</span>idCardNUmber, name<span style="color:#f92672">=</span>idCard<span style="color:#f92672">.</span>person<span style="color:#f92672">.</span>name))
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203142417516.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203142417516"
	
	
></p>
</li>
<li>
<p>反向查询：没有外键属性的一方，可以调用反向属性查询到关联的另一方。</p>
<p>注：</p>
<ul>
<li>反向关联属性为 <code>实例对象.引用类名（小写）</code>，如个人的反向引用为 <code>个人对象.idcard</code>。</li>
<li>当反向引用不存在时，则会触发异常。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 通过IdCard查找Person</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> oto.models <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>person <span style="color:#f92672">=</span> Person<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;南歌&#39;</span>)
</span></span><span style="display:flex;"><span>person<span style="color:#f92672">.</span>idcard<span style="color:#f92672">.</span>idCardNUmber
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203142911022.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203142911022"
	
	
></p>
<p>反向属性不存在时，触发异常。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203143032384.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203143032384"
	
	
></p>
</li>
</ol>
<h3 id="102-一对多映射">10.2 一对多映射</h3>
<h4 id="1021-一对多映射定义">10.2.1 一对多映射定义</h4>
<ul>
<li>一对多是表现现实事物间存在的一对多的对应关系。如：一个学校有多个班级，一个班级有多个学生，一本图书只能属于一个出版社，一个出版社允许出版多本图书。</li>
<li>一对多需要明确出具体角色，在多表上设置外键。</li>
</ul>
<h4 id="1022-一对多映射创建模型">10.2.2 一对多映射创建模型</h4>
<ul>
<li>
<p>语法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 当一个A类对象可以关联多个B类对象时</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    属性  <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>Foreignkey(<span style="color:#e6db74">&#34;一&#34;</span>的模型类<span style="color:#960050;background-color:#1e0010">，</span> on_delete<span style="color:#f92672">=</span>xx)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Fortignkey 必须指定 on_delete模式</span>
</span></span></code></pre></div></li>
</ul>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> models
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create your models here.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关系说明：一个出版社可以有多本图书，一个图书只能对应一个出版社</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Press</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    出版社
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;名称&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>, unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Book</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    图书
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;书名&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>)
</span></span><span style="display:flex;"><span>    press <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ForeignKey(Press, on_delete<span style="color:#f92672">=</span>models<span style="color:#f92672">.</span>CASCADE)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203144707614.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203144707614"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203144835619.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203144835619"
	
	
></p>
<h4 id="1023-一对多映射创建数据">10.2.3 一对多映射创建数据</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 先创建一，再创建多</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> otm.models <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>press <span style="color:#f92672">=</span> Press<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;东北大学出版社&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Book<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;C++教程&#34;</span>, press<span style="color:#f92672">=</span>press)
</span></span><span style="display:flex;"><span>Book<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Python教程&#34;</span>, press_id<span style="color:#f92672">=</span>press_id)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203145557344.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203145557344"
	
	
></p>
<h4 id="1024-一对多映射查询数据">10.2.4 一对多映射查询数据</h4>
<ol>
<li>
<p>正向查询：直接通过关联的外键属性查询，则称为正向查询。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 通过Book查找Press</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> otm.models <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>book <span style="color:#f92672">=</span> Book<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Python教程&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{book}</span><span style="color:#e6db74">的出版社是</span><span style="color:#e6db74">{name}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(book<span style="color:#f92672">=</span>book<span style="color:#f92672">.</span>name, name<span style="color:#f92672">=</span>book<span style="color:#f92672">.</span>press<span style="color:#f92672">.</span>name))
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203150909390.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203150909390"
	
	
></p>
</li>
<li>
<p>反向查询：没有外键属性的一方，可以调用反向属性查询到关联的另一方。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 通过 Press 查找 Book</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> otm.models <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>press <span style="color:#f92672">=</span> Press<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;东北大学出版社&#39;</span>)
</span></span><span style="display:flex;"><span>books <span style="color:#f92672">=</span> press<span style="color:#f92672">.</span>book_set<span style="color:#f92672">.</span>all()
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203151912867.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203151912867"
	
	
></p>
</li>
</ol>
<h3 id="103-多对多映射">10.3 多对多映射</h3>
<h4 id="1031-多对多定义">10.3.1 多对多定义</h4>
<ul>
<li>多对多表达对象之间多对多复杂关系，如：每个人都有不同的学校（小学，初中，高中，&hellip;），每个学校都有不同的学生&hellip;</li>
<li>Mysql中创建多对多需要依赖第三张表来实现。</li>
<li>Django中无需手动创建第三张表，Django自动完成。</li>
</ul>
<h4 id="1032-多对多映射创建模型">10.3.2 多对多映射创建模型</h4>
<ul>
<li>
<p>语法：在关联的两个类中的任意一个类中增加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>属性 <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ManyToManyField(MyModel)
</span></span></code></pre></div></li>
<li>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 关系说明：一个作者可以出版多本图书，一本图书可以被多名坐着同时编写</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> models
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create your models here.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Author</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;作者&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Book</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#34;书名&#34;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>)
</span></span><span style="display:flex;"><span>    authors <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ManyToManyField(Author)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203152823410.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203152823410"
	
	
></p>
</li>
</ul>
<h4 id="1033-多对多映射创建数据">10.3.3 多对多映射创建数据</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 方案一：先创建author再关联book</span>
</span></span><span style="display:flex;"><span>author1 <span style="color:#f92672">=</span> Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;南歌&#34;</span>)
</span></span><span style="display:flex;"><span>author2 <span style="color:#f92672">=</span> Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;EuanSu&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 南歌和EuanSu同时写了一本《Django教程》</span>
</span></span><span style="display:flex;"><span>book <span style="color:#f92672">=</span> author1<span style="color:#f92672">.</span>book_set<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Django教程&#34;</span>)
</span></span><span style="display:flex;"><span>author2<span style="color:#f92672">.</span>book_set<span style="color:#f92672">.</span>add(book)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方案二：先创建book再关联author</span>
</span></span><span style="display:flex;"><span>book <span style="color:#f92672">=</span> Book<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Python教程&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 南歌和EuanSu都参与了《Python教程》的编写</span>
</span></span><span style="display:flex;"><span>author <span style="color:#f92672">=</span> book<span style="color:#f92672">.</span>authors<span style="color:#f92672">.</span>create(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;南歌&#34;</span>)
</span></span><span style="display:flex;"><span>book<span style="color:#f92672">.</span>authors<span style="color:#f92672">.</span>add(author)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203153600783.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203153600783"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203154943581.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203154943581"
	
	
></p>
<h4 id="1034-多对多映射查询数据">10.3.4 多对多映射查询数据</h4>
<ol>
<li>
<p>正向查询：直接通过关联的外键属性查询，则称为正向查询。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 通过Book查询对应所有的 Author，此时多对多属性等价于objects</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 获取 book 对应的所有author信息</span>
</span></span><span style="display:flex;"><span>book<span style="color:#f92672">.</span>authors<span style="color:#f92672">.</span>all() 
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 获取book对应作者中名字为南歌的author</span>
</span></span><span style="display:flex;"><span>book<span style="color:#f92672">.</span>authors<span style="color:#f92672">.</span>filter(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;南歌&#34;</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203160248197.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203160248197"
	
	
></p>
</li>
<li>
<p>反向查询：没有外键属性的一方，可以调用反向属性查询到关联的另一方。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 通过Author查询对应所有的book，利用反向属性book_set</span>
</span></span><span style="display:flex;"><span>author<span style="color:#f92672">.</span>book_set<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>author<span style="color:#f92672">.</span>book_set<span style="color:#f92672">.</span>filter(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Django教程&#34;</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203160831514.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203160831514"
	
	
></p>
</li>
</ol>
<h2 id="11cookies和session">11.Cookies和Session</h2>
<h3 id="111-会话">11.1 会话</h3>
<ul>
<li>从打开浏览器访问一个网站，到关闭浏览器结束此次访问，称之为一次会话。</li>
<li>HTTP协议是无状态的，导致会话状态难以保持。</li>
<li>Cookies和Session就是为了保持会话状态而诞生的两个存储技术。</li>
</ul>
<h3 id="112-cookies">11.2 Cookies</h3>
<h4 id="1121-cookies定义">11.2.1 Cookies定义</h4>
<ul>
<li>
<p>Cookies是保存再客户端浏览器上的存储空间。</p>
<ul>
<li>
<p>Chrome 浏览器可能通过开发者工具的 Application &raquo; Storage &raquo; Cookies 查看和操作浏览器端所有的Cookies值。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203170139881.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203170139881"
	
	
></p>
</li>
<li>
<p>火狐浏览器 通过开发者工具的 存储 &raquo; Cookie 查看。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203170443169.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203170443169"
	
	
></p>
</li>
</ul>
</li>
</ul>
<h4 id="1122-cookies特点">11.2.2 Cookies特点</h4>
<ul>
<li>Cookies 在浏览器上是以键值对的形式进行存储到，键和值都是以ASCII字符串的形式存储（不能是中文字符串）。</li>
<li>存储的数据带有生命周期。</li>
<li>Cookies 中的数据是按照域存储隔离的，不同的域之间无法访问。</li>
<li>Cookie 的内部数据会在每次访问此网址时都会携带到服务器端，如果Cookies过大会降低响应速度。</li>
</ul>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203170944803.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203170944803"
	
	
></p>
<h4 id="1123-cookies的使用">11.2.3 Cookies的使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 设置/修改Cookie</span>
</span></span><span style="display:flex;"><span>HttpResponse<span style="color:#f92672">.</span>set_cookie(key,value<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>,max_age<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,expires<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">## key：Cookie的名字</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## value：Cookie的值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## max_age：Cookie存储时间，秒为单位</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## expires：具体的过期时间</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 当不指定 max_age 和 expires 时，关闭浏览器此时数据失效</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除/获取Cookie</span>
</span></span><span style="display:flex;"><span>HttpResponse<span style="color:#f92672">.</span>delete_cookie(key)
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 删除指定的key的Cookie，如果key不存在则什么也不发生</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取Cookies</span>
</span></span><span style="display:flex;"><span>request<span style="color:#f92672">.</span>COOKIES<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;Cookie名&#39;</span>,<span style="color:#e6db74">&#39;默认值&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 通过request.COOKIES 绑定的字典（dict）获取客户端的COOKIES数据</span>
</span></span></code></pre></div><p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 浏览器设置一个名为uname的cookie，值是euansu，过期时间为10分钟的cookie</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.shortcuts <span style="color:#f92672">import</span> render
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponse
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create your views here.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_cookies</span>(request):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> HttpResponse(<span style="color:#e6db74">&#34;set cookies&#34;</span>)
</span></span><span style="display:flex;"><span>    response<span style="color:#f92672">.</span>set_cookie(<span style="color:#e6db74">&#34;uname&#34;</span>, <span style="color:#e6db74">&#34;euansu&#34;</span>, <span style="color:#ae81ff">600</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203173519032.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203173519032"
	
	
></p>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 浏览器设置一个键为 my_cookie，值为123，过期时间为1个小时的cookie</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_cookies_new</span>(request):
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> HttpResponse(<span style="color:#e6db74">&#34;set cookies&#34;</span>)
</span></span><span style="display:flex;"><span>    response<span style="color:#f92672">.</span>set_cookie(<span style="color:#e6db74">&#34;my_cookie&#34;</span>, <span style="color:#e6db74">&#34;123&#34;</span>, <span style="color:#ae81ff">3600</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 浏览器修改 my_cookie的值为123，过期时间为2个小时</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_cookies</span>(request):
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> HttpResponse(<span style="color:#e6db74">&#34;update cookies&#34;</span>)
</span></span><span style="display:flex;"><span>    response<span style="color:#f92672">.</span>set_cookie(<span style="color:#e6db74">&#34;my_cookie&#34;</span>, <span style="color:#e6db74">&#34;456&#34;</span>, <span style="color:#ae81ff">7200</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div><p>浏览器设置 cookie</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203174306716.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203174306716"
	
	
></p>
<p>浏览器修改 cookie。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203174357891.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203174357891"
	
	
></p>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 浏览器删除Cookies</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_cookies</span>(request):
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> HttpResponse(<span style="color:#e6db74">&#34;delete cookies&#34;</span>)
</span></span><span style="display:flex;"><span>    response<span style="color:#f92672">.</span>delete_cookie(<span style="color:#e6db74">&#34;my_cookie&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203175455270.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203175455270"
	
	
></p>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 获取Cookies</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_cookies</span>(request):
</span></span><span style="display:flex;"><span>    values <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>COOKIES<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;my_cookie&#34;</span>, <span style="color:#e6db74">&#34;my_cookie&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;my_cookie value is </span><span style="color:#e6db74">{my_cookie}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(my_cookie<span style="color:#f92672">=</span>values))
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203180238529.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203180238529"
	
	
></p>
<h3 id="113-session">11.3 session</h3>
<h4 id="1131-session定义">11.3.1 session定义</h4>
<p>session 是在服务器上开辟一段空间用于保留浏览器和服务器交互时的重要数据。</p>
<p>实现方式：</p>
<ul>
<li>使用 session 需要在浏览器客户端启动 cookie，且在cookie中存储sessionid。</li>
<li>每个客户端都可以在服务器端有一个独立的session。</li>
<li>注意：不同的请求者之间不会共享这个数据，与请求者一一对应。</li>
</ul>
<h4 id="1132-session初始配置">11.3.2 session初始配置</h4>
<p><code>settings.py</code> 中配置 <code>session</code>。</p>
<ol>
<li>
<p>向 INSTALLED_APPS 列表中添加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>INSTALLED_APPS <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 启用 sessions 应用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.contrib.sessions&#39;</span>,
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
<li>
<p>向 MIDDLEWARE 列表中添加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MIDDLEWARE <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 启用 session 中间件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
</ol>
<h4 id="1133-session的使用">11.3.3 session的使用</h4>
<p>session 对象是一个类似于字典的sessionstore类型的对象，可以用类拟于字典的方式进行操作。</p>
<p>session 能够存储如字符串、整型、字典、列表等。</p>
<ol>
<li>
<p>保存 session 的值到服务器。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>request<span style="color:#f92672">.</span>session[<span style="color:#e6db74">&#39;key&#39;</span>] <span style="color:#f92672">=</span> value
</span></span></code></pre></div></li>
<li>
<p>获取 session 的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>value <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>session[<span style="color:#e6db74">&#39;key&#39;</span>]
</span></span><span style="display:flex;"><span>vakue <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;key&#39;</span>, 默认值)
</span></span></code></pre></div></li>
<li>
<p>删除 session。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">del</span> request<span style="color:#f92672">.</span>session[<span style="color:#e6db74">&#39;key&#39;</span>]
</span></span></code></pre></div></li>
</ol>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 设置session</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_session</span>(request):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    request<span style="color:#f92672">.</span>session[<span style="color:#e6db74">&#39;uname&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;euansu&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;set session is ok!&#34;</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203183851558.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203183851558"
	
	
></p>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 获取session</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_session</span>(request):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    value <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;uname&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;session unmae values is </span><span style="color:#e6db74">{value}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(value<span style="color:#f92672">=</span>value))
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203183911955.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203183911955"
	
	
></p>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 修改session</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_session</span>(request):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    request<span style="color:#f92672">.</span>session[<span style="color:#e6db74">&#39;uname&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;南歌&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;update session is ok!&#34;</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203184050356.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203184050356"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203184211232.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203184211232"
	
	
></p>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 删除session</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_session</span>(request):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">del</span> request<span style="color:#f92672">.</span>session[<span style="color:#e6db74">&#34;uname&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;delete session is ok!&#34;</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203184303818.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203184303818"
	
	
></p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203184334420.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203184334420"
	
	
></p>
<h4 id="1134-session相关配置项">11.3.4 session相关配置项</h4>
<ol>
<li>
<p>SESSION_COOKIE_AGE</p>
<p>作用：指定 sessionid 在 cookies 中的保存时长（默认是两周），如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>SESSION_COOKIE_AGE <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span><span style="color:#f92672">*</span><span style="color:#ae81ff">7</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>
</span></span></code></pre></div></li>
<li>
<p>SESSION_EXPIRE_AT_BROWSER_CLOSE = True</p>
<p>设置只要浏览器关闭时，session就失效（默认为False）</p>
</li>
</ol>
<p><!-- raw HTML omitted -->注意：Django 中的session数据存储在数据库中，所以使用session前需要确保已经执行migrate。<!-- raw HTML omitted --></p>
<h4 id="1135-django-session的问题">11.3.5 Django session的问题</h4>
<ol>
<li>django_session 表是单表设计，且该表数据量持续增持（浏览器故意删掉sessionid&amp;过期数据未删除）。</li>
<li>可以每晚执行 python3 manage.py clearsessions，该命令可以删除已过期的session数据。</li>
</ol>
<h4 id="1136-cookies-和-session-对比">11.3.6 Cookies 和 session 对比</h4>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240203190443016.png"
	
	
	
	loading="lazy"
	
		alt="image-20240203190443016"
	
	
></p>
<h2 id="12缓存">12.缓存</h2>
<h3 id="121-缓存的定义">12.1 缓存的定义</h3>
<ul>
<li>
<p>定义：缓存是一类可以更快的读取数据的介质统称，也指其他可以加快数据读取的存储方式，一般用来存储临时数据，常用介质的是读取速度很快的内存。</p>
</li>
<li>
<p>意义：视图渲染有一定成本，数据库的频繁查询过高，所以对于低频变动的页面可以考虑使用缓存技术，减少实际渲染次数，用户拿到响应的时间成本会更低。</p>
</li>
<li>
<p>Django 缓存的实现方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Django 官网</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://docs.djangoproject.com/en/5.0/topics/cache/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># given a URL, try finding that page in the cache</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> the page <span style="color:#f92672">is</span> <span style="color:#f92672">in</span> the cache:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> the cached page
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    generate the page
</span></span><span style="display:flex;"><span>    save the generated page <span style="color:#f92672">in</span> the cache (<span style="color:#66d9ef">for</span> next time)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> the generated page
</span></span></code></pre></div></li>
<li>
<p>缓存场景：</p>
<ol>
<li>博客列表页</li>
<li>电商商品详情页</li>
</ol>
<p>场景特点：缓存的地方，数据变动频率较少。</p>
</li>
</ul>
<h3 id="122-缓存的配置">12.2 缓存的配置</h3>
<h4 id="1221-mysql缓存">12.2.1 Mysql缓存</h4>
<p>将缓存的数据存储在数据库中。</p>
<p>说明：尽管存储介质没有更换，但是当把一次负责查询的结果直接存储到表里，比如多个条件的过滤查询结果，可避免重复进行复杂的查询，提升效率。</p>
<p>在 <code>settings.py</code> 中添加 <code>CACHES</code> 配置块。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>CACHES <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;default&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;BACKEND&#34;</span>: <span style="color:#e6db74">&#34;django.core.cache.backends.db.DatabaseCache&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;LOCATION&#34;</span>: <span style="color:#e6db74">&#34;my_cache_table&#34;</span>, <span style="color:#75715e"># 缓存表的名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;TIMEOUT&#34;</span>: <span style="color:#ae81ff">300</span>, <span style="color:#75715e">#缓存的保存时间，单位秒，默认值是300</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;POTIONS&#34;</span>:{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;MAX_ENTRIES&#34;</span>: <span style="color:#ae81ff">300</span>, <span style="color:#75715e"># 缓存最大的数据条数</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;CULL_FREQUENCY&#34;</span>: <span style="color:#ae81ff">2</span> <span style="color:#75715e"># 缓存条数达到最大值时，删除 1/CULL_FREQUENCY 的缓存数据</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>创建缓存表。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python3 manage.py createcachetable
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240204142505782.png"
	
	
	
	loading="lazy"
	
		alt="image-20240204142505782"
	
	
></p>
<p>查看数据库。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240204142408207.png"
	
	
	
	loading="lazy"
	
		alt="image-20240204142408207"
	
	
></p>
<p>使用 mysql 进行缓存，会将数据存储在指定的 mysql 表中。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240205235812467.png"
	
	
	
	loading="lazy"
	
		alt="image-20240205235812467"
	
	
></p>
<h4 id="1222-redis缓存">12.2.2 Redis缓存</h4>
<p><a class="link" href="https://redis.io/"  target="_blank" rel="noopener"
    >Redis</a>是一个内存数据库，可用于缓存。</p>
<p>在 <code>settings.py</code> 中添加如下 <code>CACHES</code> 块。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>CACHES <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;default&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;BACKEND&#34;</span>: <span style="color:#e6db74">&#34;django.core.cache.backends.redis.RedisCache&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;LOCATION&#34;</span>: <span style="color:#e6db74">&#34;redis://username:password@127.0.0.1:6379&#34;</span>, <span style="color:#75715e"># username、password需要看redis是否启用身份认证，如未启用，这里则不需要配置。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># &#34;LOCATION&#34;: [</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#    &#34;redis://127.0.0.1:6379&#34;,  # leader</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#    &#34;redis://127.0.0.1:6378&#34;,  # read-replica 1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#    &#34;redis://127.0.0.1:6377&#34;,  # read-replica 2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 如果有多个redis服务器时，这样配置即可</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="1223-本地内存缓存">12.2.3 本地内存缓存</h4>
<p>数据缓存到服务器内存中，如果配置文件中没有指定其他缓存，那么这是默认的缓存。如果你想获得内存缓存的速度优势，但又不具备运行 Memcached 的能力，可以考虑使用本地内存缓存后端。这个缓存是每进程所有（见下文）和线程安全的。</p>
<p>在 <code>settings.py</code> 中添加如下 <code>CACHES</code> 块。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 说明：如下仅供测试，建议将数据存储到内存数据库中，如redis</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 每个进程都会有自己的私有缓存实例，这意味着不可能进行跨进程缓存，也即本地内存缓存的内存效率不是特别高，所以对于生产环境来说，它可能不是一个好的选择。对于开发来说是不错的选择。</span>
</span></span><span style="display:flex;"><span>CACHES <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;default&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;BACKEND&#34;</span>: <span style="color:#e6db74">&#34;django.core.cache.backends.locmem.LocMemCache&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;LOCATION&#34;</span>: <span style="color:#e6db74">&#34;unique_snowflake&#34;</span>, 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="1224-文件系统缓存">12.2.4 文件系统缓存</h4>
<p>将缓存的数据存储到本地文件中。</p>
<p>在 <code>settings.py</code> 中添加如下 <code>CACHES</code> 块。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>CACHES <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;default&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;BACKEND&#34;</span>: <span style="color:#e6db74">&#34;django.core.cache.backends.filebased.FileBasedCache&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;LOCATION&#34;</span>: <span style="color:#e6db74">&#34;/home/euansu/tmp&#34;</span>, <span style="color:#75715e"># 这个是文件夹的路径</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># &#34;LOCATION&#34;: &#34;c:\test\cache&#34;, # windows下示例</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>使用文件系统缓存，会在配置的目录下生成对应的缓存文件。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240205235509437.png"
	
	
	
	loading="lazy"
	
		alt="image-20240205235509437"
	
	
></p>
<h3 id="123-整体缓存策略">12.3 整体缓存策略</h3>
<p>整体缓存这里指的是直接缓存一个视图函数全部的结果，与下部分的局部缓存形成对照。</p>
<h4 id="1231-视图函数">12.3.1 视图函数</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.views.decorators.cache <span style="color:#f92672">import</span> cache_page
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@cache_page</span>(<span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">my_view</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span></code></pre></div><p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.shortcuts <span style="color:#f92672">import</span> render
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.views.decorators.cache <span style="color:#f92672">import</span> cache_page
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponse
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create your views here.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pytz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@cache_page</span>(<span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mysql_cache</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    MysqlCache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param request: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :return: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    target_timezone <span style="color:#f92672">=</span> pytz<span style="color:#f92672">.</span>timezone(<span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span>)
</span></span><span style="display:flex;"><span>    current_time <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>now()
</span></span><span style="display:flex;"><span>    current_time_shanghai <span style="color:#f92672">=</span> current_time<span style="color:#f92672">.</span>replace(tzinfo<span style="color:#f92672">=</span>pytz<span style="color:#f92672">.</span>utc)<span style="color:#f92672">.</span>astimezone(target_timezone)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    time_string <span style="color:#f92672">=</span> current_time_shanghai<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(time_string)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240205205732896.png"
	
	
	
	loading="lazy"
	
		alt="image-20240205205732896"
	
	
></p>
<h4 id="1232-路由函数">12.3.2 路由函数</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.views.decorators.cache <span style="color:#f92672">import</span> cache_page
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#39;foo/&#39;</span>, cache_page(<span style="color:#ae81ff">60</span>)(my_view)),
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.views.decorators.cache <span style="color:#f92672">import</span> cache_page
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> views
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#34;mysql_cache/&#34;</span>, cache_page(<span style="color:#ae81ff">60</span>)(views<span style="color:#f92672">.</span>mysql_cache)),
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240205234033811.png"
	
	
	
	loading="lazy"
	
		alt="image-20240205234033811"
	
	
></p>
<h3 id="124-局部缓存策略">12.4 局部缓存策略</h3>
<p>视图函数局部耗时较多，但视图函数其他区域并不耗时。</p>
<h4 id="1241-使用场景">12.4.1 使用场景</h4>
<ul>
<li>
<p>使用场景</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 局部耗时较多，但视图函数其他区域并不耗时</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.shortcuts <span style="color:#f92672">import</span> render
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 时间复杂度极高的渲染</span>
</span></span><span style="display:flex;"><span>    book_list <span style="color:#f92672">=</span> Book<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all() <span style="color:#75715e"># 假设此处耗时2s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render(request,<span style="color:#e6db74">&#39;idnex.html&#39;</span>,locals())
</span></span></code></pre></div></li>
</ul>
<h4 id="1242-局部缓存的使用">12.4.2 局部缓存的使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 先引入cache对象</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 方式一：使用caches[&#39;CACHE配置key&#39;]导入具体对象</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.core.cache <span style="color:#f92672">import</span> cache
</span></span><span style="display:flex;"><span>cache1 <span style="color:#f92672">=</span> caches[<span style="color:#e6db74">&#39;default&#39;</span>]
</span></span><span style="display:flex;"><span>cache2 <span style="color:#f92672">=</span> caches[<span style="color:#e6db74">&#39;custom&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 方式二：</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.core.cache <span style="color:#f92672">import</span> cache
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 相当于直接引入 CACHES 配置项中的&#39;default&#39;项</span>
</span></span></code></pre></div><h4 id="1243-局部缓存的方法">12.4.3 局部缓存的方法</h4>
<ol>
<li>
<p>cache.set(key, value, timeout)，存储缓存</p>
<pre tabindex="0"><code>key：缓存的key，字符串类型
value：Python对象
timeout：缓存存储时间（s），默认为CACHES中的TIMEOUT值
返回值：None
</code></pre></li>
<li>
<p>cache.get(key)，获取缓存</p>
<pre tabindex="0"><code>key：缓存的key
返回值：为key的具体值，如果没有数据，则返回None
</code></pre></li>
<li>
<p>cache.add(key, value)，存储缓存，只在key不存在时生效</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>返回值<span style="color:#960050;background-color:#1e0010">：</span><span style="color:#66d9ef">True</span>[存储成功] <span style="color:#f92672">or</span> <span style="color:#66d9ef">False</span>[存储失败]
</span></span></code></pre></div></li>
<li>
<p>cache.get_or_set(key, value, timeout)，如果未获取到数据，则执行set操作</p>
<pre tabindex="0"><code>返回值：value
</code></pre></li>
<li>
<p>cache.set_many(dict, timeout)，批量存储缓存</p>
<pre tabindex="0"><code>dict：key和value的字典
timout：存储的时间（s）
返回值：插入不成功的key的数组
</code></pre></li>
<li>
<p>cache.get_many(key_list)，批量获取缓存数据。</p>
<pre tabindex="0"><code>key_list：包含key的数组
返回值：渠道的key和value的字典
</code></pre></li>
<li>
<p>cache.delete(key)，删除key的缓存数据。</p>
<pre tabindex="0"><code>返回值：None
</code></pre></li>
<li>
<p>cache.delete_many(key_list)，批量删除。</p>
<pre tabindex="0"><code>返回值：None
</code></pre></li>
</ol>
<h4 id="1244-局部缓存测试">12.4.4 局部缓存测试</h4>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 设置cache</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.core.cache <span style="color:#f92672">import</span> cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;uname&#34;</span>, <span style="color:#e6db74">&#34;euansu&#34;</span>, <span style="color:#ae81ff">300</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;uname&#34;</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206003131256.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206003131256"
	
	
></p>
<p>数据库中出现对应cache记录。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206003015431.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206003015431"
	
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 修改cache</span>
</span></span><span style="display:flex;"><span>cache<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;uname&#34;</span>, <span style="color:#e6db74">&#34;nange&#34;</span>, <span style="color:#ae81ff">300</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;uname&#34;</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206003235729.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206003235729"
	
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 删除cache</span>
</span></span><span style="display:flex;"><span>cache<span style="color:#f92672">.</span>delete(<span style="color:#e6db74">&#34;uname&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;uname&#34;</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206003341884.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206003341884"
	
	
></p>
<p>查询数据库，对应的缓存消失</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206003400681.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206003400681"
	
	
></p>
<h3 id="125-浏览器缓存策略">12.5 浏览器缓存策略</h3>
<p>浏览器也具备缓存技术，对于浏览器来说，每次向服务器发出请求都是耗时的操作，如果本身浏览器内部就具备当前 url 的内容，则一定时间内可以不必给服务器发消息，从而提升网页体验，降低服务器的请求压力。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/162db6359673e7d0tplv-t2oaga2asx-jj-mark_3024_0_0_0_q75.png"
	
	
	
	loading="lazy"
	
		alt="162db6359673e7d0~tplv-t2oaga2asx-jj-mark_3024_0_0_0_q75"
	
	
></p>
<!-- raw HTML omitted -->
<h4 id="1251-浏览器缓存-强缓存">12.5.1 浏览器缓存-强缓存</h4>
<p>不会向服务器发送请求，直接从缓存中读取资源。</p>
<p>服务器和浏览器之间的请求，通过如下两个响应头进行沟通。</p>
<ol>
<li>
<p>响应头 - Expires</p>
<pre tabindex="0"><code>定义：缓存过期时间，用来指定资源到期的时间，是服务器端的具体的时间点
样例：Expires:Thu, 02 Apr 2030 05:15:08 GMT
</code></pre></li>
<li>
<p>响应头 - Cache-Control</p>
<pre tabindex="0"><code>在HTTP/1.1中，Cache-Control主要用于控制网页缓存，比如当 Cache-Control:max-age=120 代表请求创建后的120秒，缓存失败
说明：目前服务器都会带着这两个头同时响应给浏览器，浏览器优先使用 Cache-Control
</code></pre></li>
</ol>
<p>例如如下请求，浏览器中显示已缓存。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206004848246.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206004848246"
	
	
></p>
<p>刷新页面，但浏览器中仅有一次请求。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206004910849.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206004910849"
	
	
></p>
<p>查看请求响应，发现返回的响应中有 <code>Cache-Control</code> 和 <code>Expires</code> 两个响应头。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206005142750.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206005142750"
	
	
></p>
<p>这里的 <code>max-age=60</code> 是通过 <code>cache-page</code> 实现的。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206005554767.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206005554767"
	
	
></p>
<p>修改 <code>cache_page</code> 的参数，响应头中的 <code>max-age</code> 也发生变化。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206005755552.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206005755552"
	
	
></p>
<h4 id="1252-浏览器缓存-协商缓存">12.5.2 浏览器缓存-协商缓存</h4>
<p>图片、静态文件等这类比较费带宽且不易变化的数据，浏览器会跟服务器协商，确认当前的缓存是否可用，如果可用，服务器不需要返回数据，浏览器继续使用原来缓存的数据，如果文件不可用，则返回最新的数据。</p>
<ol>
<li>
<p>Last-Modified 响应头和 If-Modified-Since 请求头。</p>
<p>说明：</p>
<ul>
<li>Last-modified 为文件的最近修改时间，浏览器第一次请求静态文件时，服务器第一次请求静态文件时，服务器如果返回Last-Modified响应头，则代表该资源为需要协商的缓存。</li>
<li>当缓存到期后，浏览器将获取到的 Last-Modified 值作为请求头 If-Modified-Since 的值，与服务器发请求协商，服务器端返回304响应码[响应体为空]，代表缓存继续使用，200响应码代表缓存不可用[响应体为最新资源]。</li>
</ul>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponse
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.utils <span style="color:#f92672">import</span> timezone
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">last_modified</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    测试last-modified请求头
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    last_modified_time <span style="color:#f92672">=</span> timezone<span style="color:#f92672">.</span>now()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查 If-Modified-Since 头</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>META<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;HTTP_IF_MODIFIED_SINCE&#39;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 如果资源没有发生变化，返回 304 Not Modified</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HttpResponse(status<span style="color:#f92672">=</span><span style="color:#ae81ff">304</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 如果资源发生了变化，设置 Last-Modified 响应头</span>
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> HttpResponse(<span style="color:#e6db74">&#34;Your content here&#34;</span>)
</span></span><span style="display:flex;"><span>    response[<span style="color:#e6db74">&#39;Last-Modified&#39;</span>] <span style="color:#f92672">=</span> last_modified_time<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%a</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %b %Y %H:%M:%S GMT&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206012530126.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206012530126"
	
	
></p>
</li>
<li>
<p>ETag 响应头和 If-None-Match 请求头。</p>
<p>说明：</p>
<ul>
<li>ETag时服务器响应请求时，返回当前资源文件的一个唯一标识（由服务器生成），只要资源有变化，ETag就会重新生成。</li>
<li>缓存到期后，浏览器将ETag响应头的值作为If-None-Match请求头的值，给服务器发请求协商，服务器接到请求头后，比对文件标识，不一致则认为资源不可用，返回200响应码[响应体为最新资源]，可用则返回304响应码。</li>
</ul>
<p>代码示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">etag_func</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 获取或计算资源的内容（假设这里是一个字符串）</span>
</span></span><span style="display:flex;"><span>    resource_content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Your content here&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 计算 ETag（使用 MD5 散列作为示例，你可以根据需要选择其他方法）</span>
</span></span><span style="display:flex;"><span>    etag <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>md5(resource_content<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查 If-None-Match 头</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>META<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;HTTP_IF_NONE_MATCH&#39;</span>) <span style="color:#f92672">==</span> etag:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 如果资源没有发生变化，返回 304 Not Modified</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HttpResponse(status<span style="color:#f92672">=</span><span style="color:#ae81ff">304</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 如果资源发生了变化，设置 ETag 响应头</span>
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> HttpResponse(resource_content)
</span></span><span style="display:flex;"><span>    response[<span style="color:#e6db74">&#39;ETag&#39;</span>] <span style="color:#f92672">=</span> etag
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div><p>首次访问返回200。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206012804087.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206012804087"
	
	
></p>
<p>再次请求，响应变为304。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240206012848251.png"
	
	
	
	loading="lazy"
	
		alt="image-20240206012848251"
	
	
></p>
</li>
</ol>
<h2 id="13中间件">13.中间件</h2>
<h3 id="131-中间件的定义">13.1 中间件的定义</h3>
<ul>
<li>中间件是Django请求/响应处理的钩子框架。它是一个轻量级的、低级的“插件”系统，用于全局改变Django的输入或输出。</li>
<li>中间件以类的形式体现。</li>
<li>每个中间件组件负责做一些特定的功能。例如，Django包含一个中间件组件AuthenticationMiddleware，它使用会话将用户与请求关联起来。</li>
</ul>
<h3 id="132-编写中间件">13.2 编写中间件</h3>
<ul>
<li>中间件类必须继承自django.utils.deprecation.MiddlewareMixin类。</li>
<li>中间件类必须实现下列五个方法中的一个或多个：
<ul>
<li>process_request(self, request)，执行路由之前被调用，在每个请求上调用，返回None或HttpResponse对象。</li>
<li>process_view(self, request, callback, callback_args, callback_kwargs)，调用视图之前被调用，在每个请求上调用，返回None或HttpResponse对象。</li>
<li>process_response(self, request, response)，所有响应返回浏览器被调用，在每个请求上调用，返回HttpResponse对象。</li>
<li>process_exception(self, request, exception)，当处理过程中抛出异常时调用，返回一个HttpResponse对象。</li>
<li>process_template_response(self, request, response)，在视图函数执行完毕且视图返回的对象中包含render方法时被调用，该方法需要返回实现了render方法的响应对象。</li>
</ul>
</li>
</ul>
<p>注：中间件中的大多数方法在返回None时表示忽略当前操作进入下一项事件，当返回HttpResponse对象时表示此请求结束，直接返回给客户端。</p>
<h3 id="133-注册中间件">13.3 注册中间件</h3>
<ul>
<li>
<p>settings.py中需要注册一下自定义的中间件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MIDDLEWARE <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
<li>
<p>注意：配置为数组，中间件被调用时以“先上到下”再“由下到上”的顺序调用。</p>
</li>
</ul>
<h3 id="134-中间件的使用">13.4 中间件的使用</h3>
<ol>
<li>
<p>首先是创建中间件的目录以及文件，如下图所示。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240209124029373.png"
	
	
	
	loading="lazy"
	
		alt="image-20240209124029373"
	
	
></p>
</li>
<li>
<p>编写中间件的代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.utils.deprecation <span style="color:#f92672">import</span> MiddlewareMixin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">customMiddleware</span>(MiddlewareMixin):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    自定义中间件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_request</span>(self, request):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        请求达到路由前被调用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;customMiddleware process_request 被调用&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_view</span>(self, request, callback, callback_args, callback_kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        调用视图函数前被调用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param callback:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param callback_args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param callback_kwargs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;customMiddleware process_view 被调用&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_response</span>(self, request, response):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        响应返回前被调用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param response:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;customMiddleware process_response 被调用&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div></li>
<li>
<p>注册中间件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># settings.py</span>
</span></span><span style="display:flex;"><span>MIDDLEWARE <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.middleware.security.SecurityMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.middleware.common.CommonMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># &#39;django.middleware.csrf.CsrfViewMiddleware&#39;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注册中间件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;middleware.custommiddleware.customMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
<li>
<p>中间件调用测试。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240209124219952.png"
	
	
	
	loading="lazy"
	
		alt="image-20240209124219952"
	
	
></p>
</li>
<li>
<p>中间件被调用时以“先上到下”再“由下到上”的顺序调用。</p>
<ul>
<li>
<p>增加一个新的中间件“customMiddleware2”。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">customMiddleware2</span>(MiddlewareMixin):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    自定义中间件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_request</span>(self, request):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        请求达到路由前被调用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;customMiddleware2 process_request 被调用&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_view</span>(self, request, callback, callback_args, callback_kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        调用视图函数前被调用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param callback:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param callback_args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param callback_kwargs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;customMiddleware2 process_view 被调用&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_response</span>(self, request, response):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        响应返回前被调用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param response:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;customMiddleware2 process_response 被调用&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div></li>
<li>
<p>注册中间件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MIDDLEWARE <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.middleware.security.SecurityMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.middleware.common.CommonMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># &#39;django.middleware.csrf.CsrfViewMiddleware&#39;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;middleware.custommiddleware.customMiddleware&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;middleware.custommiddleware.customMiddleware2&#39;</span>,
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
<li>
<p>调用测试。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240209130826387.png"
	
	
	
	loading="lazy"
	
		alt="image-20240209130826387"
	
	
></p>
</li>
</ul>
</li>
</ol>
<h2 id="14django内建用户系统">14.Django内建用户系统</h2>
<h3 id="141-django中的用户认证">14.1 Django中的用户认证</h3>
<ul>
<li>Django带有一个用户认证系统系统，它处理用户用户账号、组、权限以及基于cookie的用户会话。</li>
<li>用户可以直接使用Django自带的用户表。</li>
<li>官方文档：https://docs.djangoproject.com/zh-hans/2.2/topics/auth/</li>
</ul>
<h3 id="142-用户系统表的基本字段">14.2 用户系统表的基本字段</h3>
<p>模型类位置 from django.contrib.auth.models import User</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>字段名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>username</td>
<td>用户名</td>
</tr>
<tr>
<td>password</td>
<td>密码</td>
</tr>
<tr>
<td>email</td>
<td>邮箱</td>
</tr>
<tr>
<td>first_name</td>
<td>名</td>
</tr>
<tr>
<td>last_name</td>
<td>姓</td>
</tr>
<tr>
<td>is_superuser</td>
<td>是否管理员账号</td>
</tr>
<tr>
<td>is_staff</td>
<td>是否可以访问admin管理界面</td>
</tr>
<tr>
<td>is_active</td>
<td>是否是活跃用户，默认为True，一般不删除用户，而是将用户的is_active设为False</td>
</tr>
<tr>
<td>last_login</td>
<td>上一次登录时间</td>
</tr>
<tr>
<td>date_joined</td>
<td>用户创建的时间</td>
</tr>
</tbody>
</table></div>
<h3 id="143-用户系统的基本模型操作">14.3 用户系统的基本模型操作</h3>
<ol>
<li>
<p>创建普通用户 create_user：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth.models <span style="color:#f92672">import</span> User
</span></span><span style="display:flex;"><span>user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create_user(username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;用户名&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;密码&#39;</span>, email<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;邮箱&#39;</span>, <span style="color:#f92672">...</span>)
</span></span></code></pre></div></li>
<li>
<p>创建超级用户 create_superuser：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth.models <span style="color:#f92672">import</span> User
</span></span><span style="display:flex;"><span>user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create_superuser(username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;用户名&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;密码&#39;</span>, email<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;邮箱&#39;</span>, <span style="color:#f92672">...</span>)
</span></span></code></pre></div></li>
<li>
<p>删除用户：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth.models <span style="color:#f92672">import</span> User
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;用户名&#39;</span>)
</span></span><span style="display:flex;"><span>    user<span style="color:#f92672">.</span>is_active <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    user<span style="color:#f92672">.</span>save()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;删除普通用户成功&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;删除普通用户失败&#34;</span>)
</span></span></code></pre></div></li>
<li>
<p>校验密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 说明：如果用户名密码校验成功则返回对应的User对象，否则返回None</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth <span style="color:#f92672">import</span> authenticate
</span></span><span style="display:flex;"><span>user <span style="color:#f92672">=</span> authenticate(username<span style="color:#f92672">=</span>username, password<span style="color:#f92672">=</span>password)
</span></span></code></pre></div></li>
<li>
<p>修改密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth.models <span style="color:#f92672">import</span> User
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;用户名&#39;</span>)
</span></span><span style="display:flex;"><span>    user<span style="color:#f92672">.</span>set_password(<span style="color:#e6db74">&#39;123456&#39;</span>)
</span></span><span style="display:flex;"><span>    user<span style="color:#f92672">.</span>save()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;修改密码成功&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;修改密码失败&#34;</span>)
</span></span></code></pre></div></li>
<li>
<p>登录状态保持：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth <span style="color:#f92672">import</span> login,authenticate
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login_view</span>(request):
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> authenticate(username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;用户名&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;密码&#39;</span>)
</span></span><span style="display:flex;"><span>    login(request, user)
</span></span></code></pre></div></li>
<li>
<p>登录状态校验：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth.decorators <span style="color:#f92672">import</span> login_required
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index_view</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 该视图必须为用户登录状态下才可以访问</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 当前登录用户可以通过request.user获取</span>
</span></span><span style="display:flex;"><span>    login_user <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>user
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span></code></pre></div></li>
<li>
<p>用户注销登录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth <span style="color:#f92672">import</span> logout
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logout_view</span>(request):
</span></span><span style="display:flex;"><span>    logout(request)
</span></span></code></pre></div></li>
</ol>
<p>代码示例：</p>
<ol>
<li>
<p>创建 templates 目录，放置 html 页面。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210104737887.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210104737887"
	
	
></p>
</li>
<li>
<p>编写对应的template页面。</p>
<p>register.html，用户注册页。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Register&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{% url &#39;register_page&#39; %}&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        {% csrf_token %}
</span></span><span style="display:flex;"><span>        {{ form }}
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Submit&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">form</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>login.html，用户登录页。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Login&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{% url &#39;login&#39; %}&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        {% csrf_token %}
</span></span><span style="display:flex;"><span>        {{ form }}
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Submit&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">form</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>homepage.html，首页。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;homepage&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{% url &#39;logout&#39; %}&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        {% csrf_token %}
</span></span><span style="display:flex;"><span>        欢迎访问项目
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;注销用户&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">form</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div></li>
<li>
<p>编写对应的视图函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.shortcuts <span style="color:#f92672">import</span> render
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth.models <span style="color:#f92672">import</span> User
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponseRedirect, HttpResponse
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth <span style="color:#f92672">import</span> authenticate, login, logout
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .forms <span style="color:#f92672">import</span> loginForm, registerForm
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth.decorators <span style="color:#f92672">import</span> login_required
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create your views here.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login_page</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    项目登录面
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># return render(request, &#39;hello.html&#39;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        form <span style="color:#f92672">=</span> loginForm(request<span style="color:#f92672">.</span>POST)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> form<span style="color:#f92672">.</span>is_valid():
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 处理表单提交逻辑，可以访问 form.cleaned_data 获取表单字段的值</span>
</span></span><span style="display:flex;"><span>            username <span style="color:#f92672">=</span> form<span style="color:#f92672">.</span>cleaned_data[<span style="color:#e6db74">&#39;username&#39;</span>]
</span></span><span style="display:flex;"><span>            password <span style="color:#f92672">=</span> form<span style="color:#f92672">.</span>cleaned_data[<span style="color:#e6db74">&#39;password&#39;</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> username <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> password:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;请输入正确的参数&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 校验密码</span>
</span></span><span style="display:flex;"><span>            user <span style="color:#f92672">=</span> authenticate(username<span style="color:#f92672">=</span>username, password<span style="color:#f92672">=</span>password)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;校验用户&#39;</span>)
</span></span><span style="display:flex;"><span>            print(user)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;用户名或密码错误&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 记录会话状态</span>
</span></span><span style="display:flex;"><span>                login(request, user)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> HttpResponseRedirect(<span style="color:#e6db74">&#39;/homepage&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        form <span style="color:#f92672">=</span> loginForm()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render(request, <span style="color:#e6db74">&#39;login.html&#39;</span>, {<span style="color:#e6db74">&#39;form&#39;</span>: form})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_page</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    项目注册页面
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># return render(request, &#39;hello.html&#39;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        form <span style="color:#f92672">=</span> registerForm(request<span style="color:#f92672">.</span>POST)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> form<span style="color:#f92672">.</span>is_valid():
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 处理表单提交逻辑，可以访问 form.cleaned_data 获取表单字段的值</span>
</span></span><span style="display:flex;"><span>            username <span style="color:#f92672">=</span> form<span style="color:#f92672">.</span>cleaned_data[<span style="color:#e6db74">&#39;username&#39;</span>]
</span></span><span style="display:flex;"><span>            password1 <span style="color:#f92672">=</span> form<span style="color:#f92672">.</span>cleaned_data[<span style="color:#e6db74">&#39;password1&#39;</span>]
</span></span><span style="display:flex;"><span>            password2 <span style="color:#f92672">=</span> form<span style="color:#f92672">.</span>cleaned_data[<span style="color:#e6db74">&#39;password2&#39;</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> username <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> password1 <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> password2:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;请传入正确的参数&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 进行注册操作</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> password1 <span style="color:#f92672">!=</span> password2:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;两次输入的密码不一致&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 创建用户</span>
</span></span><span style="display:flex;"><span>                user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create_user(username<span style="color:#f92672">=</span>username, password<span style="color:#f92672">=</span>password1)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 注册成功</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> HttpResponseRedirect(<span style="color:#e6db74">&#39;/login&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 注册失败</span>
</span></span><span style="display:flex;"><span>                print(e)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;注册用户失败，请联系管理员进行处理&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        form <span style="color:#f92672">=</span> registerForm()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render(request, <span style="color:#e6db74">&#39;register.html&#39;</span>, {<span style="color:#e6db74">&#39;form&#39;</span>: form})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logout_func</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    注销登录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param request:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logout(request)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponseRedirect(<span style="color:#e6db74">&#39;/login&#39;</span>)
</span></span></code></pre></div></li>
<li>
<p>编写对应的路由函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path, re_path
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> views
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#34;&#34;</span>, views<span style="color:#f92672">.</span>login_page, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;login&#39;</span>),
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#34;register/&#34;</span>, views<span style="color:#f92672">.</span>register_page, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;register_page&#39;</span>),
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#34;logout/&#34;</span>, views<span style="color:#f92672">.</span>logout_func, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;logout&#39;</span>)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
<li>
<p>配置项目默认的登录页面。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># settings.py</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置了登录地址，当访问到需要登录的页面时，如果此时用户未登录，则跳转至登录页面</span>
</span></span><span style="display:flex;"><span>LOGIN_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/login&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>页面调用测试。</p>
<p>注册页面输入用户名，密码，确认密码后点击submit进行登录。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210112043282.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210112043282"
	
	
></p>
<p>成功注册后，跳转至login页面，输入刚才注册的用户名和密码，点击submit进行登录。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210112331431.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210112331431"
	
	
></p>
<p>登录成功，跳转至项目首页。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210112412307.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210112412307"
	
	
></p>
<p>再打开一个标签页，注销登录后，项目首页无法访问。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210112605282.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210112605282"
	
	
></p>
</li>
</ol>
<h3 id="144-用户系统的扩展字段">14.4 用户系统的扩展字段</h3>
<ul>
<li>通过建立新表，跟内建表做一对一映射。</li>
<li>继承内建的抽象User模型类。</li>
</ul>
<h4 id="1441-继承内部抽象类">14.4.1 继承内部抽象类</h4>
<p>步骤：</p>
<ol>
<li>添加新的应用。</li>
<li>定义模型类，集成AbstractUser。</li>
<li>settings.py中指明AUTH_USER_MODEL=&lsquo;应用名.类名&rsquo;。</li>
</ol>
<p>注：该操作需要在第一次migrate之前进行，否则会报如下的错误。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210114945393.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210114945393"
	
	
></p>
<p>代码测试：</p>
<ol>
<li>
<p>添加新的应用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python3 manage.py startapp useradmin
</span></span></code></pre></div></li>
<li>
<p>定义模型类，集成AbstractUser。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> models
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth.models <span style="color:#f92672">import</span> AbstractUser
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create your models here.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserInfo</span>(AbstractUser):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    phone <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">11</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span></code></pre></div></li>
<li>
<p>settings.py中指明AUTH_USER_MODEL=&lsquo;应用名.类名&rsquo;。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>AUTH_USER_MODEL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;useradmin.UserInfo&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>执行代码迁移。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python3 manage.py makemigrations
</span></span><span style="display:flex;"><span>python3 manage.py migrate
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210115303551.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210115303551"
	
	
></p>
</li>
<li>
<p>迁移成功后，查看数据库，auth_user表消失，出现了一个useradmin_userinfo的表。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210115343556.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210115343556"
	
	
></p>
</li>
<li>
<p>创建新用户测试。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.contrib.auth.models <span style="color:#f92672">import</span> User
</span></span><span style="display:flex;"><span>user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create_user(username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;euansu&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;euansu&#39;</span>, email<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;euansu@euansu.cn&#39;</span>, phone<span style="color:#f92672">=</span><span style="color:#ae81ff">13000000000</span>)
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210115602783.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210115602783"
	
	
></p>
<p>查看数据库</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210115647581.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210115647581"
	
	
></p>
<p>使用新创建的用户登录刚才的项目，可以正常登录。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240210115823564.png"
	
	
	
	loading="lazy"
	
		alt="image-20240210115823564"
	
	
></p>
</li>
</ol>
<h2 id="15文件上传">15.文件上传</h2>
<h3 id="151-定义场景">15.1 定义&amp;场景</h3>
<ul>
<li>定义：用户可以通过浏览器将图片等文件上传至网站。</li>
<li>场景：
<ul>
<li>用户上传头像。</li>
<li>上传流程性的文档[pdf，txt等]</li>
</ul>
</li>
</ul>
<h3 id="152-上传规范-前端html">15.2 上传规范-前端[html]</h3>
<ul>
<li>文件上传必须为POST提交方式</li>
<li>表单 <code>&lt;form&gt;</code> 中文件上传时必须带有 <code>enctype=&quot;multipart/form-data&quot;</code> 时才会包含文件内容数据。</li>
<li>表单中用 <code>&lt;input type=&quot;file&quot; name=&quot;xxx&quot;&gt;</code> 标签上传文件。</li>
</ul>
<h3 id="153-上传规范-后端django">15.3 上传规范-后端[Django]</h3>
<ul>
<li>视图函数中，用request.FILES取文件框的内容</li>
<li>file=request.FILES[&lsquo;xxx&rsquo;]</li>
</ul>
<p>说明：</p>
<ol>
<li>FILE的key对应页面中file框的name值。</li>
<li>file绑定文件流对象。</li>
<li>file.name文件名。</li>
<li>file.file文件的字节流数据。</li>
</ol>
<p>配置文件的访问路径和存储路径：</p>
<ul>
<li>
<p>在settings.py中设置MEDIA相关配置，Django把用户上传的文件统称为media资源，需要与静态资源static进行区分。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># file:settings.py</span>
</span></span><span style="display:flex;"><span>MEDIA_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/media/&#39;</span>
</span></span><span style="display:flex;"><span>MEDIA_ROOT <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(BASE_DIR, <span style="color:#e6db74">&#39;media&#39;</span>)
</span></span></code></pre></div><p>MEDIA_URL 和 MEDIA_ROOT 需要手动绑定。</p>
<p>方法：主路由中添加路由。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 说明：等价于做了MEDIA_URL开头的路由，Django接到该特征请求后去MEDIA_ROOT路径查找资源</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.conf impot settings
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.conf.urls.static <span style="color:#f92672">import</span> static
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">+=</span> static(settings<span style="color:#f92672">.</span>MEDIA_URL, document_root<span style="color:#f92672">=</span>settings<span style="color:#f92672">.</span>MEDIA_ROOT)
</span></span></code></pre></div></li>
</ul>
<p>文件写入方案1：传统的open方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@csrf_exempt</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">file_upload</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> render(request, <span style="color:#e6db74">&#39;file_upload.html&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        upload_file <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>FILES[<span style="color:#e6db74">&#39;myfile&#39;</span>]
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;上传的文件名是：&#34;</span>, upload_file<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span>        file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(settings<span style="color:#f92672">.</span>MEDIA_ROOT, upload_file<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(file_path, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>            data <span style="color:#f92672">=</span> upload_file<span style="color:#f92672">.</span>file<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>            f<span style="color:#f92672">.</span>write(data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;接收文件：&#34;</span> <span style="color:#f92672">+</span> upload_file<span style="color:#f92672">.</span>name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;成功&#34;</span>)
</span></span></code></pre></div><p>文件写入方案2：ORM</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 字段名：FileField(upload=&#39;子目录名&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@csrf_exempt</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">file_upload</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> render(request, <span style="color:#e6db74">&#39;file_upload.html&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        upload_title <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>POST[<span style="color:#e6db74">&#39;title&#39;</span>]
</span></span><span style="display:flex;"><span>        upload_file <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>FILES[<span style="color:#e6db74">&#39;myfile&#39;</span>]
</span></span><span style="display:flex;"><span>        Content<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(desc<span style="color:#f92672">=</span>upload_title, myfile<span style="color:#f92672">=</span>upload_file)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;接收文件：&#34;</span> <span style="color:#f92672">+</span> upload_file<span style="color:#f92672">.</span>name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;成功&#34;</span>)
</span></span></code></pre></div><p>文件上传代码测试：</p>
<ol>
<li>
<p>配置上传文件的访问路径和存储路径。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># settings.py</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 存储的路由</span>
</span></span><span style="display:flex;"><span>MEDIA_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/media/&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 存储的位置</span>
</span></span><span style="display:flex;"><span>MEDIA_ROOT <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(BASE_DIR, <span style="color:#e6db74">&#39;media&#39;</span>)
</span></span></code></pre></div></li>
<li>
<p>编写html静态文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># apps/templates</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">!</span>DOCTYPE html<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>html lang<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>head<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>meta charset<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>title<span style="color:#f92672">&gt;</span>文件上传<span style="color:#f92672">&lt;/</span>title<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/</span>head<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>body<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>form action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/file/upload/&#34;</span> method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span> enctype<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;multipart/form-data&#34;</span><span style="color:#f92672">&gt;</span>{<span style="color:#f92672">%</span> csrf_token <span style="color:#f92672">%</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span>p<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;</span>input type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text&#34;</span> name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/</span>p<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span>p<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;</span>input type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;myfile&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/</span>p<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span>p<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;</span>input type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> value<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;上传&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/</span>p<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/</span>form<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/</span>body<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/</span>html<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>编写model模型文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> models
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create your models here.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Content</span>(models<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    文件存储对象
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    title <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(<span style="color:#e6db74">&#39;文件名&#39;</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">11</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#子目录的名称即为：upload_to所指定的字段</span>
</span></span><span style="display:flex;"><span>    picture <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>FileField(<span style="color:#e6db74">&#39;子目录名称&#39;</span>, upload_to<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;picture&#39;</span>)
</span></span></code></pre></div></li>
<li>
<p>编写view视图文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>port render
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponse
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> .models <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create your views here.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">file_upload</span>(request):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> render(request, <span style="color:#e6db74">&#39;file_upload.html&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        title <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>POST[<span style="color:#e6db74">&#39;title&#39;</span>]
</span></span><span style="display:flex;"><span>        myfile <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>FILES[<span style="color:#e6db74">&#39;myfile&#39;</span>]
</span></span><span style="display:flex;"><span>        Content<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(title<span style="color:#f92672">=</span>title, picture<span style="color:#f92672">=</span>myfile)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;文件上传成功&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#34;请求方法错误&#34;</span>)
</span></span></code></pre></div></li>
<li>
<p>编写url路由文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> django.urls <span style="color:#f92672">import</span> path, re_path
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> views
</span></span><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    path(<span style="color:#e6db74">&#34;upload/&#34;</span>, views<span style="color:#f92672">.</span>file_upload, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file_upload&#34;</span>)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
<li>
<p>请求测试。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240211210425660.png"
	
	
	
	loading="lazy"
	
		alt="image-20240211210425660"
	
	
></p>
<p>文件上传成功。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240211210448232.png"
	
	
	
	loading="lazy"
	
		alt="image-20240211210448232"
	
	
></p>
<p>使用URL进行访问。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240211210613808.png"
	
	
	
	loading="lazy"
	
		alt="image-20240211210613808"
	
	
></p>
</li>
</ol>
<h2 id="16项目部署">16.项目部署</h2>
<h3 id="161-基本概念">16.1 基本概念</h3>
<p>项目部署是指在软件开发完毕后，将开发机器上运行的软件实际安装到服务器上进行长期运行。</p>
<ol>
<li>
<p>在安装机器上安装和配置同版本的环境[python，数据库等]</p>
</li>
<li>
<p>django项目迁移</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>scp /home/euansu/Code/Python/website euansu@xx.xx.xx.xx:/home/euansu/xxx
</span></span></code></pre></div></li>
<li>
<p>用uWSGI替代python3 manage.py runserver方法启动服务器。</p>
</li>
<li>
<p>配置nginx反向代理服务器。</p>
</li>
<li>
<p>用nginx配置静态文件路径，解决静态路径问题。</p>
</li>
</ol>
<h3 id="162-wsgi定义">16.2 WSGI定义</h3>
<p>WSGI（Web Server Gateway Interface）Web服务器网关接口，是Python应用程序或框架和web服务器之间的一种接口，被广泛使用。</p>
<p>使用Python manage.py runserver通常只在开发和测试环境中使用，当开发结束后，完善的项目代码需要在一个搞笑稳定的环境中运行，这是可以使用WSGI。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240211212557096.png"
	
	
	
	loading="lazy"
	
		alt="image-20240211212557096"
	
	
></p>
<p>开发环境中，runserver将http协议的内容规范成WSGI规范给Django处理，将WSGI的规范转换成http规范进行返回。</p>
<h3 id="163-uwsgi">16.3 uWSGI</h3>
<h4 id="1631-uwsgi定义">16.3.1 uWSGI定义</h4>
<p>uWSGI是WSGI的一种，它实现了http协议WSGI协议以及uwsgi协议。uWSGI功能完善，支持协议众多，在Python web热度极高。</p>
<p><strong>uWSGI主要以学习配置为主。</strong></p>
<h4 id="1632-uwsgi安装">16.3.2 uWSGI安装</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pip install uwsgi<span style="color:#f92672">==</span>2.0.18 -i https://pypi.tuna.tsinghua.edu.cn/simple/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查是否安装成功，如果成功安装则会输出uWSGI==2.0.18</span>
</span></span><span style="display:flex;"><span>pip freeze | grep -i <span style="color:#e6db74">&#39;uwsgi&#39;</span>
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240211213954693.png"
	
	
	
	loading="lazy"
	
		alt="image-20240211213954693"
	
	
></p>
<h4 id="1633-uwsgi配置">16.3.3 uWSGI配置</h4>
<p>添加配置文件 项目同名文件夹/uwsgi.ini，如：website/website/uwsgi.ini</p>
<p>文件以[uwsgi]开头，有如下配置项：</p>
<ul>
<li>
<p>套接字方式的 IP地址:端口号 【此模式需要有nginx】</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">socket</span><span style="color:#f92672">=</span><span style="color:#e6db74">127.0.0.1:8000</span>
</span></span></code></pre></div></li>
<li>
<p>http通信方式的 IP地址:端口号</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">http</span><span style="color:#f92672">=</span><span style="color:#e6db74">127.0.0.1:8000</span>
</span></span></code></pre></div></li>
<li>
<p>项目当前工作目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">chdir</span><span style="color:#f92672">=</span><span style="color:#e6db74">/home/euansu/website</span>
</span></span></code></pre></div></li>
<li>
<p>项目中wsgi.py文件的目录，相对于当前工作目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">wsgi-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">website/wsgi.py</span>
</span></span></code></pre></div></li>
<li>
<p>进程个数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">process</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span></code></pre></div></li>
<li>
<p>每个进程的线程个数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">threads</span><span style="color:#f92672">=</span><span style="color:#e6db74">2</span>
</span></span></code></pre></div></li>
<li>
<p>服务的pid记录文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">pidfile</span><span style="color:#f92672">=</span><span style="color:#e6db74">uwsgi.pid</span>
</span></span></code></pre></div></li>
<li>
<p>服务的日志文件，配置该选项后，说明项目后台启动，且日志输出到该文件中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">daemonize</span><span style="color:#f92672">=</span><span style="color:#e6db74">uwsgi.log</span>
</span></span></code></pre></div></li>
<li>
<p>开启主进程管理模式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">master</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span></code></pre></div></li>
</ul>
<p>特殊说明，Django的setting.py需要做如下配置：</p>
<ol>
<li>修改settings.py，将DEBUG=True改为DEBUG=False</li>
<li>修改settings.py，将ALLOWED_HOSTS=[] 改为 ALLOWED_HOSTS=[&lsquo;网站域名/服务器监听的ip地址&rsquo;]</li>
</ol>
<p>实际项目的配置文件如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># 项目名/uwsgi.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[uwsgi]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># http通信方式的 IP地址:端口号</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">http</span><span style="color:#f92672">=</span><span style="color:#e6db74">127.0.0.1:8000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 项目当前工作目录</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chdir</span><span style="color:#f92672">=</span><span style="color:#e6db74">/home/euansu/Code/Python/website</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 项目中wsgi.py文件的位置</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wsgi-file</span><span style="color:#f92672">=</span><span style="color:#e6db74">website/wsgi.py</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 进程个数</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">process</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 线程个数</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">threads</span><span style="color:#f92672">=</span><span style="color:#e6db74">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务的pid记录文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pidfile</span><span style="color:#f92672">=</span><span style="color:#e6db74">uwsgi.pid</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务的日志文件，是不是由后台启动以及日志输出到哪里</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">daemonize</span><span style="color:#f92672">=</span><span style="color:#e6db74">uwsgi.log</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启主进程管理模式</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">master</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span></code></pre></div><h4 id="1634-uwsgi的运行管理">16.3.4 uWSGI的运行管理</h4>
<ul>
<li>
<p>启动uwsgi</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># cd到uWSGI配置文件所在目录</span>
</span></span><span style="display:flex;"><span>uwsgi --ini uwsgi.ini
</span></span></code></pre></div><p>启动以及检测进程是否成功。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240211221014350.png"
	
	
	
	loading="lazy"
	
		alt="image-20240211221014350"
	
	
></p>
<p>网页访问。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240211221046750.png"
	
	
	
	loading="lazy"
	
		alt="image-20240211221046750"
	
	
></p>
</li>
<li>
<p>停止uwsgi</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># cd到uWSGI配置文件所在目录</span>
</span></span><span style="display:flex;"><span>uwsgi --stop uwsgi.pid
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240211221608439.png"
	
	
	
	loading="lazy"
	
		alt="image-20240211221608439"
	
	
></p>
</li>
</ul>
<h3 id="164-项目部署测试">16.4 项目部署测试</h3>
<ol>
<li>
<p>将项目上传至远程linux主机。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240212013154145.png"
	
	
	
	loading="lazy"
	
		alt="image-20240212013154145"
	
	
></p>
</li>
<li>
<p>启动项目，这里需要提前在远程linux主机安装python以及所需要的依赖项。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240212012824018.png"
	
	
	
	loading="lazy"
	
		alt="image-20240212012824018"
	
	
></p>
<p>页面能够正常访问到django项目的内容。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240212012903228.png"
	
	
	
	loading="lazy"
	
		alt="image-20240212012903228"
	
	
></p>
<p>注：这里启动的时候要注意，命令应该是 python manage.py runserver 0.0.0.0:8080，否则有可能出现无法访问的现象。</p>
</li>
<li>
<p>远程主机安装uWSGI。</p>
<p>这里安装uWSGI失败，报错如下，暂时无法解决，这里改用gunicorn进行项目的部署。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240212021642842.png"
	
	
	
	loading="lazy"
	
		alt="image-20240212021642842"
	
	
></p>
<p>安装Gunicorn。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pip install uvicorn
</span></span><span style="display:flex;"><span>pip install gunicorn
</span></span></code></pre></div><p>运行项目</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 后台启动</span>
</span></span><span style="display:flex;"><span>gunicorn --bind 0.0.0.0:8080 website.wsgi:application --daemon
</span></span></code></pre></div><p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240212022910514.png"
	
	
	
	loading="lazy"
	
		alt="image-20240212022910514"
	
	
></p>
<p>页面能够正常访问项目。</p>
<p><img src="/Django%E5%9F%BA%E7%A1%80/image-20240212022931270.png"
	
	
	
	loading="lazy"
	
		alt="image-20240212022931270"
	
	
></p>
</li>
</ol>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/python/">Python</a>
        
            <a href="/tags/django/">Django</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/post/django_migrate/">
        
        
            <div class="article-image">
                
                    <img src="/img/%e6%95%b0%e6%8d%ae%e5%ba%93%e8%bf%81%e7%a7%bb%e6%8a%a5%e9%94%99.png" loading="lazy" data-key="django_migrate" data-hash="/img/数据库迁移报错.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Django 数据库迁移报错问题记录</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/django_quick_start/">
        
        
            <div class="article-image">
                
                    <img src="/img/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e8%bf%90%e8%a1%8cDjango%e9%a1%b9%e7%9b%ae.png" loading="lazy" data-key="django_quick_start" data-hash="/img/从零开始运行Django项目.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Django入门记录</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/django_migrate_cancel/">
        
        
            <div class="article-image">
                
                    <img src="/img/%e6%95%b0%e6%8d%ae%e5%ba%93%e8%bf%81%e7%a7%bb%e5%9b%9e%e6%bb%9a.png" loading="lazy" data-key="django_migrate_cancel" data-hash="/img/数据库迁移回滚.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Django 数据库迁移操作的回滚</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2021 - 
        
        2024 EuanSu&#39;s Blog
    </section>
    <span class="icp">
        <a class="icp" target="_blank" href="https://beian.miit.gov.cn/">冀ICP备20005107号-2</a>
      </span>
    
    <section class="powerby">
        

        

        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.17.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
